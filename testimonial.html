
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M14.5 2.5 16 4s-1.5 1.5-3 3L11 9l1.5 1.5 3-3 1.5 1.5'/%3E%3Cpath d='m21.5 2.5-1.5 1.5'/%3E%3Cpath d='M11.5 12.5 3 21'/%3E%3Cpath d='M10 11l-1.5 1.5'/%3E%3Cpath d='m14 6 3 3'/%3E%3Cpath d='M3 21h3l9.5-9.5-3-3L3 18v3z'/%3E%3C/svg%3E" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client Testimonial Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^1.10.0"
        }
      }
    </script>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import { GoogleGenAI, Type } from "@google/genai";

      // --- From types.ts ---
      const Platform = {
        Google: 'Google',
        Facebook: 'Facebook',
        Yelp: 'Yelp',
        Trustpilot: 'Trustpilot',
      };

      const Sentiment = {
        Positive: 'Positive',
        Neutral: 'Neutral',
        Negative: 'Negative',
        Unknown: 'Unknown',
      };

      // --- From components/icons/PlatformIcons.tsx ---
      const GoogleIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.99 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
      );

      const FacebookIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
          <path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v7.01C18.343 21.128 22 16.991 22 12z"/>
        </svg>
      );

      const YelpIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
          <path d="M12.013 1.503c-5.26 0-9.524 4.263-9.524 9.523 0 5.26 4.264 9.523 9.524 9.523s9.523-4.263 9.523-9.523c0-5.26-4.263-9.523-9.523-9.523zm3.435 12.336l-1.92-3.84-2.81 3.42c-.41.49-1.12.55-1.61.13-.49-.41-.55-1.12-.13-1.61l3.52-4.27-2.28-2.03c-.45-.4-.49-1.07-.1-1.52.4-.45 1.07-.49 1.52-.1l2.42 2.15 1.06-4.11c.14-.54.69-.87 1.23-.73.54.14.87.69.73 1.23l-1.39 5.37 2.45 2.18c.45.4.49 1.07.1 1.52-.41.45-1.07.49-1.52.09z"/>
        </svg>
      );

      const TrustpilotIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
          <path d="M20.443 3.557a1.002 1.002 0 00-1.012.21L12 9.037 4.569 3.766a1 1 0 00-1.222 1.583L9.53 12l-6.183 6.65a1 1 0 001.222 1.583L12 14.963l7.431 5.27a1 1 0 001.222-1.583L14.47 12l6.183-6.651a1 1 0 00-.21-1.792z" />
        </svg>
      );


      // --- From components/icons/Icons.tsx ---
      const StarIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="0" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
      );

      const SparklesIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9 1.9 5.8 1.9-5.8 5.8-1.9-5.8-1.9z"/>
          </svg>
      );

      const EditIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      );

      const CheckCircleIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      );

      const XCircleIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
      );

      const BeakerIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
              <path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/>
          </svg>
      );

      const TestTubeDiagonalIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2.5 16 4s-1.5 1.5-3 3L11 9l1.5 1.5 3-3 1.5 1.5"/><path d="m21.5 2.5-1.5 1.5"/><path d="M11.5 12.5 3 21"/><path d="M10 11l-1.5 1.5"/><path d="m14 6 3 3"/><path d="M3 21h3l9.5-9.5-3-3L3 18v3z"/></svg>
      );

      const LayoutDashboardIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="3" y="15" width="7" height="5"/><rect x="14" y="11" width="7" height="9"/></svg>
      );

      const PaletteIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
      );

      const ChevronLeftIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="15 18 9 12 15 6"/></svg>
      );

      const ChevronRightIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6"/></svg>
      );

      const TrendingUpIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
      );

      const CodeBracketIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" />
          </svg>
      );

      const ClipboardIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a2.25 2.25 0 0 1-2.25 2.25H9.75A2.25 2.25 0 0 1 7.5 4.5v0a2.25 2.25 0 0 1 .084-.612M12 21.75v-13.5M12 21.75c3.037 0 5.5-2.686 5.5-6s-2.463-6-5.5-6-5.5 2.686-5.5 6 2.463 6 5.5 6Z" />
          </svg>
      );

      const ChartPieIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" />
          <path strokeLinecap="round" strokeLinejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" />
        </svg>
      );

      const LightBulbIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.311a7.5 7.5 0 0 1-7.5 0c-1.42 0-2.798-.31-4.09-1.002a7.5 7.5 0 1 1 15.68-1.002c-1.29.692-2.67 1.002-4.09 1.002Z" />
        </svg>
      );

      const TagIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
          <path strokeLinecap="round" strokeLinejoin="round" d="M6 6h.008v.008H6V6Z" />
        </svg>
      );

      const ChatBubbleBottomCenterTextIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.006 3 11.5c0 2.252.85 4.33 2.25 5.914.482.508.668 1.16.592 1.815-.082.834-.26 1.622-.586 2.282A2.25 2.25 0 0 0 7.5 21h9a2.25 2.25 0 0 0 2.148-1.741c-.326-.66-.504-1.448-.586-2.282-.076-.655.11-1.307.592-1.815A8.963 8.963 0 0 0 12 20.25ZM7.5 10.5h9M7.5 13.5h9" />
        </svg>
      );

      const LanguageIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="m10.5 21 5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C13.18 7.061 14.1 8.25 15 9.75M9 8.25c0 1.22.32 2.368.868 3.318m0 0c.548.95.992 2.023 1.306 3.132m-9.44-2.83c.31-.62.68-1.193 1.09-1.71" />
          </svg>
      );

      const UsersIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.962a3.75 3.75 0 1 0-7.5 0 3.75 3.75 0 0 0 7.5 0ZM10.5 1.5a9 9 0 1 0 4.243 16.243" />
          </svg>
      );

      const TrophyIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 0 0 9 0Z" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 9.75L7.5 12l-1.5 1.5m11.25-3L16.5 12l1.5 1.5M12 21v-3.362a4.5 4.5 0 0 0-4.5-4.5H6.75a4.5 4.5 0 0 0-4.5 4.5v3.362" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 21v-3.362a4.5 4.5 0 0 1 4.5-4.5h.75a4.5 4.5 0 0 1 4.5 4.5v3.362" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v1.875m0 0a3.75 3.75 0 1 0 0 7.5 3.75 3.75 0 0 0 0-7.5Z" />
          </svg>
      );

      const DocumentTextIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2Z" />
          </svg>
      );

      const TrashIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
          </svg>
      );

      const PlusIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
      );

      const KeyIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
          </svg>
      );


      // --- From constants.ts ---
      const MOCK_TESTIMONIALS = [
        {
          id: 'g1',
          platform: Platform.Google,
          author: 'Elena Rodriguez',
          authorImage: 'https://picsum.photos/id/1011/100/100',
          rating: 5,
          originalText: '¡Servicio absolutamente increíble! El personal fue muy amable y servicial. Lo recomendaría a todos. ¡Volveré seguro!',
          editedText: '¡Servicio absolutamente increíble! El personal fue muy amable y servicial. Lo recomendaría a todos. ¡Volveré seguro!',
          date: '2024-07-25',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'f1',
          platform: Platform.Facebook,
          author: 'Ben Carter',
          authorImage: 'https://picsum.photos/id/1012/100/100',
          rating: 4,
          originalText: 'Good experience overall. The product is solid but the shipping took a bit longer than expected. would buy again tho.',
          editedText: 'Good experience overall. The product is solid but the shipping took a bit longer than expected. Would buy again though.',
          date: '2024-07-22',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'y1',
          platform: Platform.Yelp,
          author: 'Chloe Dubois',
          authorImage: 'https://picsum.photos/id/1025/100/100',
          rating: 3,
          originalText: 'C\'était correct, je suppose. Rien de spécial à raconter. Le prix était juste mais l\'atmosphère manquait un peu.',
          date: '2024-07-20',
          sentiment: Sentiment.Neutral,
          isApproved: false,
        },
        {
          id: 't1',
          platform: Platform.Trustpilot,
          author: 'Diana Prince',
          authorImage: 'https://picsum.photos/id/1027/100/100',
          rating: 5,
          originalText: 'FANTASTIC! Couldnt be happier with the results. The team went above and beyond my expectations. 10/10',
          editedText: 'FANTASTIC! Couldn\'t be happier with the results. The team went above and beyond my expectations. 10/10',
          date: '2024-07-18',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'g2',
          platform: Platform.Google,
          author: 'Marcus Cole',
          authorImage: 'https://picsum.photos/id/103/100/100',
          rating: 2,
          originalText: 'very disapointing. the item arrived broken and customer suport was no help at all. took ages to get a reply.',
          date: '2024-07-15',
          sentiment: Sentiment.Negative,
          isApproved: false,
        },
        {
          id: 'f2',
          platform: Platform.Facebook,
          author: 'Fiona Glenanne',
          authorImage: 'https://picsum.photos/id/104/100/100',
          rating: 5,
          originalText: 'love love love this place! best cappucino in town, hands down. the vibe is so cozy and inviting.',
          editedText: 'Love, love, love this place! Best cappuccino in town, hands down. The vibe is so cozy and inviting.',
          date: '2024-07-12',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'y2',
          platform: Platform.Yelp,
          author: 'George Miller',
          authorImage: 'https://picsum.photos/id/1051/100/100',
          rating: 1,
          originalText: 'Terrible. Just terrible. Avoid at all costs. I wish I could give zero stars.',
          date: '2024-07-10',
          sentiment: Sentiment.Negative,
          isApproved: false,
        },
          {
          id: 't2',
          platform: Platform.Trustpilot,
          author: 'Hannah Sterling',
          authorImage: 'https://picsum.photos/id/106/100/100',
          rating: 5,
          originalText: 'The best of both worlds! Fast delivery and a high-quality product. You get the limo out front!',
          editedText: 'The best of both worlds! Fast delivery and a high-quality product. You get the limo out front!',
          date: '2024-07-08',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'g3',
          platform: Platform.Google,
          author: 'Isabelle Moreau',
          authorImage: 'https://picsum.photos/id/201/100/100',
          rating: 4,
          originalText: 'Très bon produit, conforme à la description. La livraison a été rapide. Je suis satisfaite de mon achat.',
          date: '2024-07-05',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'f3',
          platform: Platform.Facebook,
          author: 'Javier Castillo',
          authorImage: 'https://picsum.photos/id/202/100/100',
          rating: 2,
          originalText: 'El producto no funcionó como se esperaba. El soporte al cliente fue lento y no resolvió mi problema.',
          date: '2024-07-02',
          sentiment: Sentiment.Negative,
          isApproved: false,
        },
        {
          id: 'y3',
          platform: Platform.Yelp,
          author: 'Kenji Tanaka',
          authorImage: 'https://picsum.photos/id/203/100/100',
          rating: 4,
          originalText: 'Solid 4-star experience. The food was great, service was a little slow during peak hours but understandable.',
          date: '2024-06-30',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 't3',
          platform: Platform.Trustpilot,
          author: 'Liam O\'Connell',
          authorImage: 'https://picsum.photos/id/204/100/100',
          rating: 3,
          originalText: 'It\'s fine. Does the job. Not amazing, not terrible, just perfectly average.',
          date: '2024-06-28',
          sentiment: Sentiment.Neutral,
          isApproved: false,
        },
        {
          id: 'g4',
          platform: Platform.Google,
          author: 'Megan Chen',
          authorImage: 'https://picsum.photos/id/305/100/100',
          rating: 5,
          originalText: 'An absolutely flawless experience from start to finish. The attention to detail is remarkable. Highly recommend!',
          date: '2024-06-25',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'f4',
          platform: Platform.Facebook,
          author: 'Nadia Petrova',
          authorImage: 'https://picsum.photos/id/306/100/100',
          rating: 4,
          originalText: 'I liked it a lot! The interface is clean and user-friendly. A few more features would make it perfect.',
          date: '2024-06-22',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'y4',
          platform: Platform.Yelp,
          author: 'Oscar Martinez',
          authorImage: 'https://picsum.photos/id/307/100/100',
          rating: 3,
          originalText: 'The ambiance was nice, but my order was incorrect. They fixed it, but it took a while.',
          date: '2024-06-20',
          sentiment: Sentiment.Neutral,
          isApproved: false,
        },
        {
          id: 't4',
          platform: Platform.Trustpilot,
          author: 'Priya Singh',
          authorImage: 'https://picsum.photos/id/308/100/100',
          rating: 1,
          originalText: 'A complete waste of money. The product broke after one use. Customer service was unhelpful.',
          date: '2024-06-18',
          sentiment: Sentiment.Negative,
          isApproved: false,
        },
        {
          id: 'g5',
          platform: Platform.Google,
          author: 'Quentin Chevalier',
          authorImage: 'https://picsum.photos/id/401/100/100',
          rating: 5,
          originalText: 'Le service client est exceptionnel. Ils ont résolu mon problème en quelques minutes. Bravo!',
          date: '2024-06-15',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'f5',
          platform: Platform.Facebook,
          author: 'Rachel Green',
          authorImage: 'https://picsum.photos/id/402/100/100',
          rating: 4,
          originalText: 'We were on a break... from bad service! This place was great. Fun staff, good prices.',
          date: '2024-06-12',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'y5',
          platform: Platform.Yelp,
          author: 'Sofia Reyes',
          authorImage: 'https://picsum.photos/id/403/100/100',
          rating: 5,
          originalText: 'Mi lugar favorito. La comida es deliciosa y el ambiente es perfecto. ¡Siempre una gran experiencia!',
          date: '2024-06-10',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 't5',
          platform: Platform.Trustpilot,
          author: 'Tom Haverford',
          authorImage: 'https://picsum.photos/id/404/100/100',
          rating: 3,
          originalText: 'Treat Yo\' Self... to something better. This was mediocre at best. The app is fine, but the swag is weak.',
          date: '2024-06-08',
          sentiment: Sentiment.Neutral,
          isApproved: false,
        },
        {
          id: 'g6',
          platform: Platform.Google,
          author: 'Uma Thurman',
          authorImage: 'https://picsum.photos/id/501/100/100',
          rating: 5,
          originalText: 'A five-star rating, clear and simple. The quality is top-notch, and the delivery was swift.',
          date: '2024-06-05',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 'f6',
          platform: Platform.Facebook,
          author: 'Victor Vance',
          authorImage: 'https://picsum.photos/id/502/100/100',
          rating: 2,
          originalText: 'The website is confusing and I couldn\'t find what I was looking for. Had to give up.',
          date: '2024-06-02',
          sentiment: Sentiment.Negative,
          isApproved: false,
        },
        {
          id: 'y6',
          platform: Platform.Yelp,
          author: 'Wendy Rhoades',
          authorImage: 'https://picsum.photos/id/503/100/100',
          rating: 4,
          originalText: 'A very effective service. It performs as advertised, achieving the stated goals with precision. A few minor tweaks could enhance the user journey.',
          date: '2024-05-30',
          sentiment: Sentiment.Positive,
          isApproved: true,
        },
        {
          id: 't6',
          platform: Platform.Trustpilot,
          author: 'Xavier Dupont',
          authorImage: 'https://picsum.photos/id/504/100/100',
          rating: 1,
          originalText: 'Je suis très déçu. Le produit est arrivé endommagé et le service client ne répond pas.',
          date: '2024-05-28',
          sentiment: Sentiment.Negative,
          isApproved: false,
        },
      ];

      const PLATFORM_CONFIG = {
        [Platform.Google]: {
          icon: 'GoogleIcon',
          color: 'text-gray-600',
          bg: 'bg-gray-100',
        },
        [Platform.Facebook]: {
          icon: 'FacebookIcon',
          color: 'text-blue-600',
          bg: 'bg-blue-100',
        },
        [Platform.Yelp]: {
          icon: 'YelpIcon',
          color: 'text-red-700',
          bg: 'bg-red-100',
        },
        [Platform.Trustpilot]: {
          icon: 'TrustpilotIcon',
          color: 'text-emerald-600',
          bg: 'bg-emerald-100',
        },
      };

      const FONT_OPTIONS = ['Inter', 'Roboto', 'Lato', 'Montserrat', 'Open Sans'];


      // --- From components/Toaster.tsx ---
      let toastId = 0;
      const toastListeners = [];
      const toastState = {
        toasts: [],
      };
      const notify = () => {
        toastListeners.forEach(listener => listener(toastState.toasts));
      };
      const addToast = (message, type) => {
        const id = toastId++;
        toastState.toasts = [...toastState.toasts, { id, message, type }];
        notify();
        setTimeout(() => {
          toastState.toasts = toastState.toasts.filter(t => t.id !== id);
          notify();
        }, 4000);
      };
      const toast = {
        success: (message) => addToast(message, 'success'),
        error: (message) => addToast(message, 'error'),
        info: (message) => addToast(message, 'info'),
      };
      const Toast = ({ message, onDismiss }) => {
          const [isVisible, setIsVisible] = React.useState(false);
          React.useEffect(() => {
              setIsVisible(true);
              const timer = setTimeout(() => {
                  setIsVisible(false);
                  setTimeout(onDismiss, 300);
              }, 3500);
              return () => clearTimeout(timer);
          }, [onDismiss]);
          const baseClasses = "flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow-lg transition-all duration-300 transform";
          const visibilityClasses = isVisible ? "translate-x-0 opacity-100" : "translate-x-full opacity-0";
          const typeClasses = {
              success: {
                  icon: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path></svg>,
                  bg: 'bg-emerald-100',
                  text: 'text-emerald-500'
              },
              error: {
                  icon: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg>,
                  bg: 'bg-red-100',
                  text: 'text-red-500'
              },
              info: {
                  icon: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"></path></svg>,
                  bg: 'bg-gray-100',
                  text: 'text-gray-500'
              }
          };
          return (
              <div className={`${baseClasses} ${visibilityClasses}`} role="alert">
                  <div className={`inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg ${typeClasses[message.type].bg} ${typeClasses[message.type].text}`}>
                      {typeClasses[message.type].icon}
                  </div>
                  <div className="ml-3 text-sm font-normal text-gray-600">{message.message}</div>
                  <button onClick={() => setIsVisible(false)} type="button" className="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex h-8 w-8" aria-label="Close">
                      <span className="sr-only">Close</span>
                      <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg>
                  </button>
              </div>
          );
      };
      const Toaster = () => {
          const [toasts, setToasts] = React.useState(toastState.toasts);
          const onDismiss = React.useCallback((id) => {
              setToasts(currentToasts => currentToasts.filter(t => t.id !== id));
          }, []);
          React.useEffect(() => {
              const listener = (newToasts) => {
                  setToasts([...newToasts]);
              };
              toastListeners.push(listener);
              return () => {
                  const index = toastListeners.indexOf(listener);
                  if (index > -1) {
                      toastListeners.splice(index, 1);
                  }
              };
          }, []);
          return (
              <div className="fixed top-5 right-5 z-50">
                  {toasts.map(toast => (
                      <Toast key={toast.id} message={toast} onDismiss={() => onDismiss(toast.id)} />
                  ))}
              </div>
          );
      };


      // --- From services/geminiService.ts ---
      const keywordStatSchema = {
          type: Type.OBJECT,
          properties: {
              keyword: { type: Type.STRING, description: 'The identified keyword or phrase.'},
              count: { type: Type.NUMBER, description: 'The frequency of the keyword.' }
          },
          required: ['keyword', 'count']
      };
      const analyticsSchema = {
          type: Type.OBJECT,
          properties: {
              sentimentBreakdown: {
                  type: Type.OBJECT,
                  description: "A breakdown of testimonial counts by sentiment.",
                  properties: {
                      [Sentiment.Positive]: { type: Type.NUMBER, description: "Count of positive testimonials" },
                      [Sentiment.Neutral]: { type: Type.NUMBER, description: "Count of neutral testimonials" },
                      [Sentiment.Negative]: { type: Type.NUMBER, description: "Count of negative testimonials" },
                  },
              },
              positiveKeywords: {
                  type: Type.ARRAY,
                  description: "List of top 5-7 most common positive keywords/phrases and their frequency.",
                  items: keywordStatSchema,
              },
              negativeKeywords: {
                  type: Type.ARRAY,
                  description: "List of top 5-7 most common negative keywords/phrases from complaints and their frequency.",
                  items: keywordStatSchema,
              },
              brandPerceptionSummary: {
                  type: Type.STRING,
                  description: "A brief 2-3 sentence summary of how the brand is perceived based on all testimonials."
              },
              complaints: {
                  type: Type.ARRAY,
                  description: "A list of specific complaints found in negative reviews. Only list up to 5.",
                  items: {
                      type: Type.OBJECT,
                      properties: {
                          platform: { type: Type.STRING, enum: Object.values(Platform) },
                          complaint: { type: Type.STRING, description: "A short quote or summary of the specific complaint." },
                          testimonialId: { type: Type.STRING, description: "The ID of the testimonial with the complaint." }
                      }
                  }
              },
              languageUsage: {
                type: Type.ARRAY,
                description: "A list of objects, each containing a language and its count.",
                items: {
                    type: Type.OBJECT,
                    required: ['language', 'count'],
                    properties: {
                        language: { type: Type.STRING, description: 'The identified language.'},
                        count: { type: Type.NUMBER, description: 'Number of testimonials in this language.' }
                    }
                }
            }
          }
      };
      const competitionReportSchema = {
          type: Type.OBJECT,
          properties: {
              ourSummary: {
                  type: Type.OBJECT,
                  properties: {
                      avgRating: { type: Type.NUMBER },
                      positivePercent: { type: Type.NUMBER },
                      strengths: { type: Type.ARRAY, items: { type: Type.STRING } },
                      positiveKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                      negativeKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                      languageUsage: {
                          type: Type.ARRAY,
                          items: {
                              type: Type.OBJECT,
                              properties: { language: { type: Type.STRING }, count: { type: Type.NUMBER } }
                          }
                      }
                  },
                  required: ['avgRating', 'positivePercent', 'strengths', 'positiveKeywords', 'negativeKeywords', 'languageUsage']
              },
              competitorSummary: {
                  type: Type.OBJECT,
                  properties: {
                      avgRating: { type: Type.NUMBER },
                      positivePercent: { type: Type.NUMBER },
                      strengths: { type: Type.ARRAY, items: { type: Type.STRING } },
                      positiveKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                      negativeKeywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                      languageUsage: {
                          type: Type.ARRAY,
                          description: "For competitor, language count should be a percentage if raw counts are unavailable.",
                          items: {
                              type: Type.OBJECT,
                              properties: { language: { type: Type.STRING }, count: { type: Type.NUMBER } }
                          }
                      }
                  },
                  required: ['avgRating', 'positivePercent', 'strengths', 'positiveKeywords', 'negativeKeywords', 'languageUsage']
              },
              comparativeAnalysis: {
                  type: Type.STRING,
                  description: "A 2-3 sentence comparative summary highlighting key differences and competitive advantages."
              }
          }
      };
      class GeminiService {
          ai;
          model = 'gemini-2.5-flash';

          constructor(apiKey) {
              if (!apiKey) {
                  throw new Error("Gemini API key is required.");
              }
              this.ai = new GoogleGenAI({ apiKey });
          }

          async handleError(error, context) {
              console.error(`Error in ${context}:`, error);
              throw new Error(`Failed to perform AI action: ${context}. Please check your API key and network connection.`);
          }

          async cleanTestimonialWithAI(text) {
              const prompt = `Correct the spelling and grammar of the following user testimonial but preserve its original tone and meaning. Do not add any extra text, commentary, or quotation marks. Only return the corrected testimonial text.\n\nTestimonial: "${text}"\n\nCorrected Testimonial:`;

              try {
                  const response = await this.ai.models.generateContent({
                      model: this.model,
                      contents: prompt,
                      config: { temperature: 0.2, topP: 0.8, topK: 10 }
                  });
                  return response.text.trim();
              } catch (error) {
                  return this.handleError(error, "cleanTestimonialWithAI");
              }
          }

          async analyzeSentimentWithAI(text) {
              const prompt = `Analyze the sentiment of the following testimonial. Respond with only one word: 'Positive', 'Neutral', or 'Negative'.\n\nTestimonial: "${text}"\n\nSentiment:`;

              try {
                  const response = await this.ai.models.generateContent({
                      model: this.model,
                      contents: prompt,
                      config: { temperature: 0.1 }
                  });
                  const sentimentStr = response.text.trim();
                  if (Object.values(Sentiment).includes(sentimentStr)) {
                      return sentimentStr;
                  }
                  return Sentiment.Unknown;
              } catch (error) {
                  return this.handleError(error, "analyzeSentimentWithAI");
              }
          }

          async generateAnalyticsReport(testimonials) {
              if (!testimonials || testimonials.length === 0) {
                  return {
                      sentimentBreakdown: {}, positiveKeywords: [], negativeKeywords: [],
                      brandPerceptionSummary: 'Not enough data to generate a report.',
                      complaints: [], languageUsage: [],
                  };
              }
              const simplifiedTestimonials = testimonials.map(t => ({
                  id: t.id, platform: t.platform, rating: t.rating, sentiment: t.sentiment, text: t.originalText,
              }));

              const prompt = `As a professional data analyst, analyze the following JSON data of customer testimonials.\nYour entire response must be a single JSON object that conforms to the provided schema. Do not include any text outside of the JSON object.\n\nBased on this data, generate a report covering:\n1.  **Sentiment Breakdown**: Count the number of testimonials for each sentiment category (Positive, Neutral, Negative).\n2.  **Primary Keywords**: Extract the top 5-7 most relevant and frequent positive keywords/phrases that describe strengths, and the top 5-7 negative keywords/phrases that describe weaknesses or complaints. For each keyword or phrase, provide its frequency count within the provided data.\n3.  **Brand Perception**: Write a concise (2-3 sentences) summary of the overall brand perception.\n4.  **Points of Complaint**: Identify specific complaints from testimonials with a negative tone. For each, provide the platform, a direct quote or summary of the complaint, and the testimonial ID. Only list up to 5 major complaints.\n5.  **Language Usage**: Identify the language of each testimonial. Return an array of objects, where each object contains a 'language' (string) and 'count' (number) key-value pair (e.g., [{"language": "English", "count": 10}, {"language": "Spanish", "count": 1}]).\n\nHere is the testimonial data:\n${JSON.stringify(simplifiedTestimonials, null, 2)}`;

              try {
                  const response = await this.ai.models.generateContent({
                      model: this.model,
                      contents: prompt,
                      config: { responseMimeType: "application/json", responseSchema: analyticsSchema }
                  });
                  
                  const jsonText = response.text.trim();
                  const report = JSON.parse(jsonText);
                  
                  report.sentimentBreakdown = {
                      [Sentiment.Positive]: report.sentimentBreakdown.Positive || 0,
                      [Sentiment.Neutral]: report.sentimentBreakdown.Neutral || 0,
                      [Sentiment.Negative]: report.sentimentBreakdown.Negative || 0,
                      [Sentiment.Unknown]: 0
                  };
                  return report;
              } catch (error) {
                  return this.handleError(error, "generateAnalyticsReport");
              }
          }

          async generateCompetitionReport(ourTestimonials, competitor) {
              if (ourTestimonials.length === 0) {
                  throw new Error("Not enough data for comparison.");
              }

              const knownLinks = Object.values(competitor.platformLinks).filter(Boolean).join(', ');
              const competitorInsightsPrompt = `Based on a Google Search, provide a detailed summary of customer reviews for the company "${competitor.name}". Include their perceived strengths, weaknesses, common keywords in positive and negative reviews, an estimated average rating out of 5 stars, and an estimated percentage of positive reviews. If available, prioritize information from these sources: ${knownLinks || 'N/A'}.`;

              const searchResponse = await this.ai.models.generateContent({
                  model: this.model,
                  contents: competitorInsightsPrompt,
                  config: { tools: [{googleSearch: {}}] },
              });
              const competitorInsights = searchResponse.text;

              if (!competitorInsights) {
                  throw new Error("Could not retrieve competitor insights from Google Search.");
              }

              const simplifiedTestimonials = ourTestimonials.map(t => ({ rating: t.rating, text: t.originalText, sentiment: t.sentiment }));
              const comparisonPrompt = `As a market research analyst, compare two companies. My company's data is in JSON format, and the competitor's data is a text summary from a web search.\nYour entire response must be a single JSON object that conforms to the provided schema. Do not include text outside the JSON object.\n\nHere is the data:\n- "ourCompanyData": ${JSON.stringify(simplifiedTestimonials, null, 2)}\n- "competitorName": "${competitor.name}"\n- "competitorSummary": "${competitorInsights}"\n\nAnalyze both datasets and generate a report covering:\n1.  **Our Summary**: Based on "ourCompanyData", calculate our average rating, percentage of positive reviews, list top 3 strengths, top 5 positive and negative keywords, and analyze language usage providing raw counts.\n2.  **Competitor Summary**: Based on their summary, extract or estimate the competitor's average rating, percentage of positive reviews, list their top 3 strengths, top 5 positive and negative keywords, and their language usage. If their language breakdown is not explicitly available, assume "English" is 100%. If it is available as percentages, provide those numbers.\n3.  **Comparative Analysis**: Write a brief (2-3 sentences) summary comparing the two, highlighting our competitive advantages or areas for improvement.`;

              try {
                  const reportResponse = await this.ai.models.generateContent({
                      model: this.model,
                      contents: comparisonPrompt,
                      config: {
                          responseMimeType: "application/json",
                          responseSchema: competitionReportSchema,
                          temperature: 0.3
                      }
                  });
                  const jsonText = reportResponse.text.trim();
                  return JSON.parse(jsonText);
              } catch(error) {
                  return this.handleError(error, "generateCompetitionReport");
              }
          }
      }


      // --- From components/ApiKeyModal.tsx ---
      const ApiKeyModal = ({ value, onChange, onClose }) => {
          const [localKey, setLocalKey] = React.useState(value);
          
          const handleSave = () => {
              onChange(localKey);
              onClose();
              toast.success("API Key saved!");
          };

          return (
              <div className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4" onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="api-key-modal-title">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                      <header className="flex justify-between items-center p-4 border-b border-gray-200">
                          <h2 id="api-key-modal-title" className="text-xl font-bold">Set Gemini API Key</h2>
                          <button onClick={onClose} className="text-gray-400 hover:text-gray-600" aria-label="Close">
                              <XCircleIcon className="h-7 w-7" />
                          </button>
                      </header>
                      <main className="p-6 space-y-4">
                          <p className="text-sm text-gray-600">
                              To use AI-powered features like text cleaning and analytics, you need a Gemini API key. 
                              You can get one from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-orange-500 hover:underline font-medium">Google AI Studio</a>.
                          </p>
                          <div>
                              <label htmlFor="api-key" className="block text-sm font-medium text-gray-700">Your API Key</label>
                              <input
                                  type="password"
                                  id="api-key"
                                  value={localKey}
                                  onChange={e => setLocalKey(e.target.value)}
                                  className="mt-1 w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500"
                                  placeholder="Enter your API key here"
                              />
                          </div>
                      </main>
                      <footer className="px-6 py-3 bg-gray-50 text-right">
                          <button onClick={handleSave} className="px-4 py-2 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600">
                              Save Key
                          </button>
                      </footer>
                  </div>
              </div>
          );
      };


      // --- From components/ReportModal.tsx ---
      const ReportModal = ({ report, onClose }) => {
          const PlatformIcon = ({ platform, className = "h-5 w-5" }) => {
              switch (platform) {
                  case Platform.Google: return <GoogleIcon className={className} />;
                  case Platform.Facebook: return <FacebookIcon className={className} />;
                  case Platform.Yelp: return <YelpIcon className={className} />;
                  case Platform.Trustpilot: return <TrustpilotIcon className={className} />;
                  default: return null;
              }
          };

          const Section = ({ title, icon, children }) => (
              <div className="bg-white p-6 rounded-lg shadow">
                  <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                      {React.cloneElement(icon, { className: "h-6 w-6 mr-3 text-orange-500" })}
                      {title}
                  </h3>
                  {children}
              </div>
          );
          
          const totalSentiments = Object.values(report.sentimentBreakdown).reduce((a, b = 0) => a + b, 0);

          return (
              <div 
                  className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4"
                  onClick={onClose}
                  role="dialog"
                  aria-modal="true"
                  aria-labelledby="report-title"
              >
                  <div 
                      className="bg-gray-100 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col"
                      onClick={e => e.stopPropagation()}
                  >
                      <header className="flex justify-between items-center p-4 border-b border-gray-200 sticky top-0 bg-gray-100 z-10">
                          <h2 id="report-title" className="text-2xl font-bold">Detailed Analytics Report</h2>
                          <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                              <XCircleIcon className="h-8 w-8" />
                              <span className="sr-only">Close</span>
                          </button>
                      </header>
                      
                      <main className="p-6 overflow-y-auto space-y-6">
                          <Section title="Brand Perception Summary" icon={<LightBulbIcon />}>
                              <p className="text-gray-600 italic">"{report.brandPerceptionSummary}"</p>
                          </Section>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <Section title="Sentiment Breakdown" icon={<ChartPieIcon />}>
                                 <ul className="space-y-2">
                                      {Object.entries(report.sentimentBreakdown).map(([sentiment, count]) => {
                                          if(sentiment === 'Unknown' || !count || count === 0) return null;
                                          const percentage = totalSentiments > 0 ? ((count || 0) / totalSentiments) * 100 : 0;
                                          return (
                                              <li key={sentiment}>
                                                  <div className="flex justify-between text-sm">
                                                      <span>{sentiment}</span>
                                                      <span>{count} ({percentage.toFixed(1)}%)</span>
                                                  </div>
                                              </li>
                                          );
                                      })}
                                  </ul>
                              </Section>
                              <Section title="Language Usage" icon={<LanguageIcon />}>
                                   {report.languageUsage && report.languageUsage.length > 0 ? (
                                      <ul className="space-y-2 text-sm">
                                          {report.languageUsage.map(({ language, count }) => (
                                              <li key={language}><strong>{language}:</strong> {count} review(s)</li>
                                          ))}
                                      </ul>
                                  ) : <p className="text-sm text-gray-500">Could not determine language usage.</p>}
                              </Section>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <Section title="Positive Keywords" icon={<TagIcon />}>
                                  <div className="flex flex-wrap gap-2">
                                      {report.positiveKeywords.length > 0 ? report.positiveKeywords.map(({ keyword, count }, i) => (
                                          <span key={i} className="px-2.5 py-1 text-sm font-medium rounded-full bg-emerald-100 text-emerald-800">
                                              {keyword} <span className="opacity-75">({count})</span>
                                          </span>
                                      )) : <p className="text-sm text-gray-500">None identified.</p>}
                                  </div>
                              </Section>
                              <Section title="Negative Keywords" icon={<TagIcon />}>
                                   <div className="flex flex-wrap gap-2">
                                      {report.negativeKeywords.length > 0 ? report.negativeKeywords.map(({ keyword, count }, i) => (
                                          <span key={i} className="px-2.5 py-1 text-sm font-medium rounded-full bg-red-100 text-red-800">
                                              {keyword} <span className="opacity-75">({count})</span>
                                          </span>
                                      )) : <p className="text-sm text-gray-500">None identified.</p>}
                                  </div>
                              </Section>
                          </div>

                          <Section title="Points of Complaint" icon={<ChatBubbleBottomCenterTextIcon />}>
                              {report.complaints.length > 0 ? (
                                  <div className="overflow-x-auto">
                                      <table className="w-full text-sm text-left text-gray-500">
                                          <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                              <tr>
                                                  <th scope="col" className="px-4 py-3">Platform</th>
                                                  <th scope="col" className="px-4 py-3">Complaint</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              {report.complaints.map((c, i) => (
                                                  <tr key={i} className="border-b">
                                                      <td className="px-4 py-3">
                                                          <div className="flex items-center space-x-2">
                                                              <PlatformIcon platform={c.platform} className={`h-4 w-4 ${PLATFORM_CONFIG[c.platform].color}`} />
                                                              <span>{c.platform}</span>
                                                          </div>
                                                      </td>
                                                      <td className="px-4 py-3 italic">"{c.complaint}"</td>
                                                  </tr>
                                              ))}
                                          </tbody>
                                      </table>
                                  </div>
                              ) : <p className="text-sm text-gray-500">No specific complaints found.</p>}
                          </Section>
                      </main>
                  </div>
              </div>
          );
      };

      // --- From components/WidgetPreview.tsx ---
      const WidgetPreview = ({ settings, testimonials }) => {
        const [currentIndex, setCurrentIndex] = React.useState(0);
        
        const hasTestimonials = testimonials && testimonials.length > 0;
        const currentTestimonial = hasTestimonials ? testimonials[currentIndex] : null;

        const goToPrevious = () => {
          if (!hasTestimonials) return;
          const isFirst = currentIndex === 0;
          const newIndex = isFirst ? testimonials.length - 1 : currentIndex - 1;
          setCurrentIndex(newIndex);
        };

        const goToNext = () => {
          if (!hasTestimonials) return;
          const isLast = currentIndex === testimonials.length - 1;
          const newIndex = isLast ? 0 : currentIndex + 1;
          setCurrentIndex(newIndex);
        };
        
        const containerStyle = {
          backgroundColor: settings.backgroundColor,
          color: settings.textColor,
          fontFamily: `'${settings.font}', sans-serif`,
        };

        const primaryStyle = {
          color: settings.primaryColor,
        };

        return (
          <div
            className="p-8 rounded-xl shadow-2xl transition-all duration-300 w-full max-w-2xl mx-auto"
            style={containerStyle}
          >
            {hasTestimonials && currentTestimonial ? (
              <div className="relative">
                <button onClick={goToPrevious} className="absolute -left-4 top-1/2 -translate-y-1/2 bg-white/50 p-1 rounded-full hover:bg-white transition-colors" style={{color: settings.primaryColor}} aria-label="Previous testimonial">
                  <ChevronLeftIcon className="h-6 w-6" />
                </button>
                
                <div className="text-center">
                  <div className="flex justify-center mb-4">
                    {[...Array(5)].map((_, i) => (
                      <StarIcon
                        key={i}
                        className={`h-6 w-6 ${i < currentTestimonial.rating ? '' : 'opacity-30'}`}
                        style={{ color: i < currentTestimonial.rating ? settings.primaryColor : settings.textColor }}
                      />
                    ))}
                  </div>
                  <p className="text-lg md:text-xl italic mb-6">"{currentTestimonial.editedText || currentTestimonial.originalText}"</p>
                  <div className="font-bold text-md uppercase tracking-wide" style={primaryStyle}>
                    {currentTestimonial.author}
                  </div>
                  <p className="text-sm opacity-70">{currentTestimonial.date}</p>
                </div>

                <button onClick={goToNext} className="absolute -right-4 top-1/2 -translate-y-1/2 bg-white/50 p-1 rounded-full hover:bg-white transition-colors" style={{color: settings.primaryColor}} aria-label="Next testimonial">
                  <ChevronRightIcon className="h-6 w-6" />
                </button>

                <div className="absolute bottom-[-2rem] left-1/2 -translate-x-1/2 flex space-x-2">
                  {testimonials.map((_, index) => (
                      <button key={index} onClick={() => setCurrentIndex(index)} className={`h-2 rounded-full transition-all duration-300 ${currentIndex === index ? 'w-6' : 'w-2'}`} style={{backgroundColor: currentIndex === index ? settings.primaryColor : settings.textColor, opacity: currentIndex === index ? 1 : 0.3}} aria-label={`Go to testimonial ${index + 1}`}></button>
                  ))}
                </div>

              </div>
            ) : (
              <div className="text-center py-10">
                <p className="opacity-70">Approve some testimonials to see them in the widget preview.</p>
              </div>
            )}
          </div>
        );
      };

      // --- From components/WidgetCustomizer.tsx ---
      const WidgetCustomizer = ({ settings, setSettings, testimonials }) => {
        const handleSettingChange = (key, value) => {
          setSettings(prev => ({ ...prev, [key]: value }));
        };
        
        const handleThemeChange = (theme) => {
          if (theme === 'light') {
              setSettings({
                  ...settings,
                  theme: 'light',
                  primaryColor: '#f97316',
                  textColor: '#374151',
                  backgroundColor: '#FFFFFF',
              });
          } else {
              setSettings({
                  ...settings,
                  theme: 'dark',
                  primaryColor: '#fb923c',
                  textColor: '#E5E7EB',
                  backgroundColor: '#1F2937',
              });
          }
        }

        const generateEmbedCode = () => {
          const testimonialsJson = JSON.stringify(testimonials.map(t => ({
              author: t.author,
              rating: t.rating,
              text: t.editedText || t.originalText,
              date: t.date
          })));

          const styles = `
            --widget-bg: ${settings.backgroundColor};
            --widget-text: ${settings.textColor};
            --widget-primary: ${settings.primaryColor};
            --widget-font: '${settings.font}', sans-serif;
          `;

          const html = `
      <div id="testimonial-widget-container" style="${styles}"></div>
      <script>
      (function() {
          const data = ${testimonialsJson};
          const container = document.getElementById('testimonial-widget-container');
          container.style.fontFamily = 'var(--widget-font)';
          container.style.backgroundColor = 'var(--widget-bg)';
          container.style.color = 'var(--widget-text)';
          container.style.padding = '1rem';
          container.style.borderRadius = '0.5rem';
          
          data.forEach(testimonial => {
              const card = document.createElement('div');
              card.style.border = '1px solid #e5e7eb';
              card.style.borderRadius = '0.5rem';
              card.style.padding = '1rem';
              card.style.marginBottom = '1rem';
              
              const author = document.createElement('p');
              author.style.fontWeight = 'bold';
              author.textContent = testimonial.author;
              
              const text = document.createElement('p');
              text.textContent = \`"\${testimonial.text}"\`;
              
              card.appendChild(author);
              card.appendChild(text);
              container.appendChild(card);
          });
      })();
      <\/script>`;
          return html;
        };

        const copyToClipboard = () => {
          navigator.clipboard.writeText(generateEmbedCode())
            .then(() => toast.success('Embed code copied to clipboard!'))
            .catch(err => toast.error('Failed to copy code.'));
        };

        const ColorInput = ({ label, value, onChange }) => (
            <div>
              <label className="block text-sm font-medium text-gray-700">{label}</label>
              <div className="mt-1 flex items-center space-x-2">
                <input
                  type="color"
                  value={value}
                  onChange={e => onChange(e.target.value)}
                  className="w-8 h-8 rounded-md border-none cursor-pointer p-0"
                  style={{backgroundColor: 'transparent', appearance: 'none', WebkitAppearance: 'none'}}
                />
                <input
                  type="text"
                  value={value}
                  onChange={e => onChange(e.target.value)}
                  className="w-full text-sm border-gray-300 bg-white rounded-md"
                />
              </div>
            </div>
          );

        return (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-1 space-y-6 bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-bold">Widget Customizer</h2>
              
              <div>
                <label className="block text-sm font-medium text-gray-700">Theme</label>
                <div className="mt-1 grid grid-cols-2 gap-2 rounded-md bg-gray-200 p-1">
                  <button onClick={() => handleThemeChange('light')} className={`px-3 py-1 rounded text-sm transition-all ${settings.theme === 'light' ? 'bg-white shadow text-orange-600' : 'text-gray-600'}`}>Light</button>
                  <button onClick={() => handleThemeChange('dark')} className={`px-3 py-1 rounded text-sm transition-all ${settings.theme === 'dark' ? 'bg-white shadow text-orange-600' : 'text-gray-600'}`}>Dark</button>
                </div>
              </div>

              <div className="space-y-4">
                <ColorInput label="Primary Color" value={settings.primaryColor} onChange={v => handleSettingChange('primaryColor', v)} />
                <ColorInput label="Text Color" value={settings.textColor} onChange={v => handleSettingChange('textColor', v)} />
                <ColorInput label="Background Color" value={settings.backgroundColor} onChange={v => handleSettingChange('backgroundColor', v)} />
              </div>

              <div>
                <label htmlFor="font" className="block text-sm font-medium text-gray-700">Font Family</label>
                <select
                  id="font"
                  value={settings.font}
                  onChange={e => handleSettingChange('font', e.target.value)}
                  className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 bg-white focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm rounded-md"
                >
                  {FONT_OPTIONS.map(font => <option key={font}>{font}</option>)}
                </select>
              </div>

              <div>
                  <h3 className="text-lg font-semibold flex items-center"><CodeBracketIcon className="mr-2 h-5 w-5"/>Embed Code</h3>
                  <div className="mt-2 relative">
                      <pre className="bg-gray-100 text-gray-800 p-4 rounded-md text-xs overflow-x-auto">
                          <code>{generateEmbedCode()}</code>
                      </pre>
                      <button onClick={copyToClipboard} className="absolute top-2 right-2 p-1.5 bg-gray-300 rounded-md hover:bg-gray-400">
                          <ClipboardIcon className="h-4 w-4 text-gray-700"/>
                      </button>
                  </div>
              </div>
            </div>
            
            <div className="lg:col-span-2">
              <h2 className="text-2xl font-bold mb-6">Live Preview</h2>
              <div className="sticky top-24">
                  <WidgetPreview settings={settings} testimonials={testimonials} />
              </div>
            </div>
          </div>
        );
      };

      // --- From components/CompetitionAnalysis.tsx ---
      const CompetitionAnalysis = ({
          competitors,
          onAnalyze,
          onSave,
          onDelete,
          report,
          isAnalyzing,
          isApiKeySet
      }) => {
          const CompetitorModal = ({ isOpen, onClose, onSave, initialData }) => {
              const [competitor, setCompetitor] = React.useState({ name: '', platformLinks: {} });
              const [id, setId] = React.useState(null);

              React.useEffect(() => {
                  if (initialData) {
                      setCompetitor({
                          name: initialData.name || '',
                          platformLinks: initialData.platformLinks || {}
                      });
                      setId(initialData.id || null);
                  } else {
                      setCompetitor({ name: '', platformLinks: {} });
                      setId(null);
                  }
              }, [initialData]);
              
              if (!isOpen) return null;

              const handleSave = () => {
                  if (!competitor.name) return; 
                  const competitorToSave = {
                      id: id || `comp_${Date.now()}`,
                      ...competitor
                  };
                  onSave(competitorToSave);
                  onClose();
              };
              
              const handleLinkChange = (platform, url) => {
                  setCompetitor(prev => ({
                      ...prev,
                      platformLinks: { ...prev.platformLinks, [platform]: url }
                  }));
              };

              return (
                  <div className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4" onClick={onClose}>
                      <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                          <header className="flex justify-between items-center p-4 border-b border-gray-200">
                              <h2 className="text-xl font-bold">{id ? 'Edit Competitor' : 'Add Competitor'}</h2>
                              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                  <XCircleIcon className="h-7 w-7" />
                              </button>
                          </header>
                          <main className="p-6 space-y-4">
                              <div>
                                  <label htmlFor="competitor-name" className="block text-sm font-medium text-gray-700">Competitor Name</label>
                                  <input
                                      type="text"
                                      id="competitor-name"
                                      value={competitor.name}
                                      onChange={e => setCompetitor(prev => ({ ...prev, name: e.target.value }))}
                                      className="mt-1 w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500"
                                      placeholder="e.g., Global Tech Inc."
                                  />
                              </div>
                              <div>
                                  <p className="block text-sm font-medium text-gray-700">Review Page Links (Optional)</p>
                                  <div className="space-y-2 mt-1">
                                      {Object.values(Platform).map(p => (
                                          <div key={p}>
                                              <label htmlFor={`link-${p}`} className="block text-xs font-medium text-gray-500">{p}</label>
                                              <input
                                                  type="url"
                                                  id={`link-${p}`}
                                                  value={competitor.platformLinks[p] || ''}
                                                  onChange={e => handleLinkChange(p, e.target.value)}
                                                  className="mt-1 w-full text-sm bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500"
                                                  placeholder={`https://reviews.example.com/...`}
                                              />
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          </main>
                          <footer className="px-6 py-3 bg-gray-50 text-right">
                              <button onClick={handleSave} className="px-4 py-2 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 disabled:bg-orange-300 disabled:cursor-not-allowed transition-colors">
                                  Save Competitor
                              </button>
                          </footer>
                      </div>
                  </div>
              );
          };
          
          const LoadingSpinner = ({size = 'h-5 w-5', color = 'text-white'}) => (
            <svg className={`animate-spin ${color} ${size}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          );

          const ComparisonCard = ({ title, usValue, themValue, usLabel = "You", themLabel = "Competitor", icon }) => (
              <div className="bg-white p-6 rounded-lg shadow-md">
                  <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                      {React.cloneElement(icon, { className: "h-6 w-6 mr-3 text-orange-500" })}
                      {title}
                  </h3>
                  <div className="grid grid-cols-2 gap-4 text-center">
                      <div>
                          <p className="text-xs text-gray-500 uppercase font-semibold">{usLabel}</p>
                          <p className="text-2xl font-bold text-orange-500">{usValue}</p>
                      </div>
                      <div>
                          <p className="text-xs text-gray-500 uppercase font-semibold">{themLabel}</p>
                          <p className="text-2xl font-bold text-indigo-500">{themValue}</p>
                      </div>
                  </div>
              </div>
          );

          const StrengthsList = ({ title, strengths, color }) => {
              const colorClasses = color === 'orange' 
                  ? 'border-orange-500 bg-orange-50 text-orange-800' 
                  : 'border-indigo-500 bg-indigo-50 text-indigo-800';
              
              return (
                  <div className="bg-white p-6 rounded-lg shadow-md h-full">
                      <h3 className="text-lg font-bold text-gray-800 mb-4">{title}</h3>
                      <ul className="space-y-3">
                          {strengths && strengths.length > 0 ? strengths.map((strength, i) => (
                              <li key={i} className={`text-sm border-l-4 p-2 pl-3 ${colorClasses}`}>
                                  {strength}
                              </li>
                          )) : <p className="text-sm text-gray-500">No specific strengths identified.</p>}
                      </ul>
                  </div>
              );
          };

          const ComparisonDetailsCard = ({
              title,
              icon,
              ourData,
              competitorData,
              ourLabel = "You",
              competitorLabel = "Competitor"
          }) => (
              <div className="bg-white p-6 rounded-lg shadow-md md:col-span-1">
                  <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                      {React.cloneElement(icon, { className: "h-6 w-6 mr-3 text-orange-500" })}
                      {title}
                  </h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                      <div>
                          <p className="text-sm font-semibold text-gray-600 mb-2">{ourLabel}</p>
                          {ourData}
                      </div>
                      <div>
                          <p className="text-sm font-semibold text-gray-600 mb-2">{competitorLabel}</p>
                          {competitorData}
                      </div>
                  </div>
              </div>
          );

          const KeywordListDisplay = ({ keywords, colorClass }) => (
              <div className="flex flex-wrap gap-2">
                  {keywords && keywords.length > 0 ? keywords.map((keyword, i) => (
                      <span key={i} className={`px-2 py-0.5 text-xs font-medium rounded-full ${colorClass}`}>
                          {keyword}
                      </span>
                  )) : <p className="text-sm text-gray-500">None identified.</p>}
              </div>
          );

          const LanguageListDisplay = ({ languages, isPercentage = false }) => (
              <ul className="space-y-1 text-sm text-gray-600">
                  {languages && languages.length > 0 ? languages.map(({ language, count }) => (
                      <li key={language}><strong>{language}:</strong> {count}{isPercentage ? '%' : ' review(s)'}</li>
                  )) : <p className="text-sm text-gray-500">Not available.</p>}
              </ul>
          );

          const [isModalOpen, setIsModalOpen] = React.useState(false);
          const [editingCompetitor, setEditingCompetitor] = React.useState(null);
          const [analyzingId, setAnalyzingId] = React.useState(null);
          const [activeReportFor, setActiveReportFor] = React.useState('');

          const handleAnalyzeClick = (competitor) => {
              setAnalyzingId(competitor.id);
              setActiveReportFor(competitor.name);
              onAnalyze(competitor).finally(() => setAnalyzingId(null));
          };

          const handleEdit = (competitor) => {
              setEditingCompetitor(competitor);
              setIsModalOpen(true);
          };

          const handleAddNew = () => {
              setEditingCompetitor(null);
              setIsModalOpen(true);
          }
          
          return (
              <div className="space-y-8">
                  <CompetitorModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={onSave} initialData={editingCompetitor}/>
                  <section>
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                          <div className="flex items-center">
                              <TrophyIcon className="h-7 w-7 text-amber-500 mr-3" />
                              <h2 className="text-2xl font-bold text-gray-800">Competition Watchlist</h2>
                          </div>
                          <button 
                              onClick={handleAddNew}
                              className="mt-2 sm:mt-0 flex items-center px-4 py-2 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 transition-colors"
                          >
                              <PlusIcon className="h-5 w-5 mr-2" />
                              Add Competitor
                          </button>
                      </div>

                      <div className="bg-white rounded-lg shadow-md">
                         <ul className="divide-y divide-gray-200">
                           {competitors.length > 0 ? competitors.map(c => (
                              <li key={c.id} className="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                  <span className="font-semibold text-gray-900">{c.name}</span>
                                  <div className="flex items-center gap-2 flex-shrink-0">
                                      <button 
                                          onClick={() => handleAnalyzeClick(c)} 
                                          disabled={isAnalyzing || !isApiKeySet}
                                          className="flex items-center justify-center px-3 py-1.5 text-xs font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 disabled:bg-orange-300 disabled:cursor-not-allowed transition-colors"
                                      >
                                          {isAnalyzing && analyzingId === c.id 
                                              ? <><LoadingSpinner size="h-4 w-4" /> <span className="ml-2">Analyzing...</span></>
                                              : <><BeakerIcon className="h-4 w-4 mr-1.5" /><span>Analyze</span></>
                                          }
                                      </button>
                                      <button onClick={() => handleEdit(c)} className="p-2 text-gray-500 hover:text-orange-600 transition-colors"><EditIcon className="h-4 w-4"/></button>
                                      <button onClick={() => onDelete(c.id)} className="p-2 text-gray-500 hover:text-red-600 transition-colors"><TrashIcon className="h-4 w-4"/></button>
                                  </div>
                              </li>
                           )) : (
                              <p className="p-6 text-center text-gray-500">Your watchlist is empty. Add a competitor to get started.</p>
                           )}
                         </ul>
                      </div>
                  </section>

                  {(isAnalyzing || report) && (
                      <section>
                          <h3 className="text-xl font-bold text-gray-800 mb-4">Analysis Results for <span className="text-indigo-500">{activeReportFor}</span></h3>
                          {isAnalyzing ? (
                              <div className="text-center py-10 bg-white rounded-lg shadow">
                                  <div className="flex justify-center items-center">
                                      <LoadingSpinner size="h-8 w-8" color="text-orange-500" />
                                      <p className="text-lg ml-4 text-gray-600">AI is comparing reviews...</p>
                                  </div>
                              </div>
                          ) : report && (
                              <div className="space-y-6">
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                      <ComparisonCard 
                                          title="Average Rating"
                                          usValue={report.ourSummary.avgRating.toFixed(2)}
                                          themValue={report.competitorSummary.avgRating.toFixed(2)}
                                          themLabel={activeReportFor}
                                          icon={<StarIcon/>}
                                      />
                                       <ComparisonCard 
                                          title="Positive Sentiment"
                                          usValue={`${report.ourSummary.positivePercent.toFixed(1)}%`}
                                          themValue={`${report.competitorSummary.positivePercent.toFixed(1)}%`}
                                          themLabel={activeReportFor}
                                          icon={<UsersIcon/>}
                                      />
                                  </div>
                                   <div className="bg-white p-6 rounded-lg shadow-md">
                                      <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                          <LightBulbIcon className="h-6 w-6 mr-3 text-orange-500" />
                                          Comparative Analysis
                                      </h3>
                                      <p className="text-gray-600 italic">"{report.comparativeAnalysis}"</p>
                                  </div>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                      <StrengthsList title="Your Strengths" strengths={report.ourSummary.strengths} color="orange" />
                                      <StrengthsList title={`${activeReportFor}'s Strengths`} strengths={report.competitorSummary.strengths} color="indigo" />
                                      <ComparisonDetailsCard
                                          title="Positive Keywords"
                                          icon={<TagIcon />}
                                          ourData={<KeywordListDisplay keywords={report.ourSummary.positiveKeywords} colorClass="bg-emerald-100 text-emerald-800" />}
                                          competitorData={<KeywordListDisplay keywords={report.competitorSummary.positiveKeywords} colorClass="bg-emerald-100 text-emerald-800" />}
                                          competitorLabel={activeReportFor}
                                      />
                                      <ComparisonDetailsCard
                                          title="Negative Keywords"
                                          icon={<TagIcon />}
                                          ourData={<KeywordListDisplay keywords={report.ourSummary.negativeKeywords} colorClass="bg-red-100 text-red-800" />}
                                          competitorData={<KeywordListDisplay keywords={report.competitorSummary.negativeKeywords} colorClass="bg-red-100 text-red-800" />}
                                          competitorLabel={activeReportFor}
                                      />
                                      <div className="md:col-span-2">
                                        <ComparisonDetailsCard
                                            title="Language Analysis"
                                            icon={<LanguageIcon />}
                                            ourData={<LanguageListDisplay languages={report.ourSummary.languageUsage} />}
                                            competitorData={<LanguageListDisplay languages={report.competitorSummary.languageUsage} isPercentage={true} />}
                                            competitorLabel={activeReportFor}
                                        />
                                      </div>
                                  </div>
                              </div>
                          )}
                      </section>
                  )}
              </div>
          );
      };

      // --- From components/TestimonialCard.tsx ---
      const TestimonialCard = ({
        testimonial,
        onClean,
        onAnalyzeSentiment,
        onUpdateText,
        onApprove,
        loadingStates,
        isApiKeySet,
        isSelected,
        onSelect
      }) => {
        const [isEditing, setIsEditing] = React.useState(false);
        const [editText, setEditText] = React.useState(testimonial.editedText || testimonial.originalText);
        
        const PlatformIcon = ({ platform, className="h-6 w-6" }) => {
            switch (platform) {
                case Platform.Google: return <GoogleIcon className={className} />;
                case Platform.Facebook: return <FacebookIcon className={className} />;
                case Platform.Yelp: return <YelpIcon className={className} />;
                case Platform.Trustpilot: return <TrustpilotIcon className={className} />;
                default: return null;
            }
        };

        const LoadingSpinner = () => (
          <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        );

        const { id, platform, author, authorImage, rating, originalText, date, sentiment, isApproved } = testimonial;
        const platformConfig = PLATFORM_CONFIG[platform];
        const isLoading = loadingStates[id]?.cleaning || loadingStates[id]?.sentiment;

        const handleSave = () => {
          onUpdateText(id, editText);
          setIsEditing(false);
        };

        const sentimentClasses = {
          [Sentiment.Positive]: 'bg-emerald-100 text-emerald-800',
          [Sentiment.Neutral]: 'bg-gray-100 text-gray-800',
          [Sentiment.Negative]: 'bg-red-100 text-red-800',
          [Sentiment.Unknown]: 'bg-gray-100 text-gray-800',
        };

        const ringClass = isSelected 
          ? 'ring-2 ring-orange-500 shadow-orange-200' 
          : isApproved 
          ? 'ring-2 ring-emerald-500' 
          : 'ring-1 ring-gray-200';

        return (
          <div className={`relative bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 ${ringClass}`}>
            <div className="absolute top-4 left-4 z-10">
              <input 
                  type="checkbox"
                  checked={isSelected}
                  onChange={() => onSelect(id)}
                  className="h-5 w-5 rounded border-gray-400 text-orange-600 focus:ring-orange-500 cursor-pointer"
                  onClick={(e) => e.stopPropagation()}
                  aria-label={`Select testimonial from ${author}`}
              />
            </div>
            <div className="p-5">
              <div className="flex justify-between items-start">
                <div className="flex items-center space-x-3 ml-8">
                  <img className="h-12 w-12 rounded-full object-cover" src={authorImage} alt={author} />
                  <div>
                    <p className="text-md font-bold text-gray-900">{author}</p>
                    <p className="text-xs text-gray-500">{new Date(date).toLocaleDateString()}</p>
                  </div>
                </div>
                <div className={`${platformConfig.bg} p-2 rounded-full`}>
                  <PlatformIcon platform={platform} className={`h-6 w-6 ${platformConfig.color}`} />
                </div>
              </div>

              <div className="flex items-center my-3 ml-8">
                {[...Array(5)].map((_, i) => (
                  <StarIcon key={i} className={`h-5 w-5 ${i < rating ? 'text-amber-400' : 'text-gray-300'}`} />
                ))}
                <span className={`ml-3 px-2 py-0.5 text-xs font-semibold rounded-full ${sentimentClasses[sentiment]}`}>{sentiment}</span>
              </div>

              <div className="space-y-4 ml-8">
                <div>
                  <h4 className="text-xs font-semibold text-gray-400 uppercase tracking-wider">Original</h4>
                  <p className="text-sm text-gray-600 italic">"{originalText}"</p>
                </div>
                
                {testimonial.cleanedText && (
                  <div>
                    <div className="flex items-center justify-between">
                      <h4 className="text-xs font-semibold text-gray-400 uppercase tracking-wider">AI Enhanced / Edited</h4>
                      <button onClick={() => setIsEditing(!isEditing)} className="text-gray-400 hover:text-orange-500">
                        <EditIcon className="h-4 w-4" />
                      </button>
                    </div>
                    {isEditing ? (
                      <div>
                        <textarea
                          value={editText}
                          onChange={(e) => setEditText(e.target.value)}
                          className="w-full p-2 text-sm bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500"
                          rows={4}
                        />
                        <button onClick={handleSave} className="mt-2 px-3 py-1 text-xs bg-orange-500 text-white rounded-md hover:bg-orange-600">Save</button>
                      </div>
                    ) : (
                      <p className="text-sm text-gray-800 font-medium">"{testimonial.editedText}"</p>
                    )}
                  </div>
                )}
              </div>
            </div>
            
            <div className="bg-gray-50 px-5 py-3">
              <div className="flex flex-wrap gap-2 justify-between items-center">
                  <div className="flex gap-2">
                      <button
                          onClick={() => onClean(id, originalText)}
                          disabled={isLoading || !isApiKeySet}
                          className="flex items-center px-3 py-1.5 text-xs font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                          title={!isApiKeySet ? "API Key not set" : "Clean with AI"}
                      >
                          {loadingStates[id]?.cleaning ? <LoadingSpinner /> : <SparklesIcon className="h-4 w-4 mr-1.5" />}
                          Clean
                      </button>
                      <button
                          onClick={() => onAnalyzeSentiment(id, originalText)}
                          disabled={isLoading || !isApiKeySet}
                          className="flex items-center px-3 py-1.5 text-xs font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                           title={!isApiKeySet ? "API Key not set" : "Analyze Sentiment"}
                      >
                          {loadingStates[id]?.sentiment ? <LoadingSpinner /> : <BeakerIcon className="h-4 w-4 mr-1.5" />}
                          Analyze
                      </button>
                  </div>
                  
                  <button
                      onClick={() => onApprove(id, !isApproved)}
                      className={`flex items-center px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${
                      isApproved
                          ? 'bg-red-100 text-red-700 hover:bg-red-200'
                          : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200'
                      }`}
                  >
                      {isApproved ? <XCircleIcon className="h-4 w-4 mr-1.5" /> : <CheckCircleIcon className="h-4 w-4 mr-1.5" />}
                      {isApproved ? 'Unapprove' : 'Approve'}
                  </button>
              </div>
            </div>
          </div>
        );
      };

      // --- From components/Dashboard.tsx ---
      const Dashboard = ({
        featuredTestimonials,
        analyticsReport,
        isAnalyzing,
        onGenerateAnalytics,
        listTestimonials,
        allFilteredTestimonials,
        onLoadMore,
        platformFilter,
        setPlatformFilter,
        sentimentFilter,
        setSentimentFilter,
        timeRange,
        setTimeRange,
        ratingFilter,
        setRatingFilter,
        approvalFilter,
        setApprovalFilter,
        sortBy,
        setSortBy,
        onBatchApprove,
        onBatchClean,
        onBatchAnalyzeSentiment,
        onClean,
        onAnalyzeSentiment,
        onUpdateText,
        onApprove,
        loadingStates,
        isApiKeySet,
      }) => {
        const LoadingSpinner = ({size = 'h-5 w-5'}) => (
          <svg className={`animate-spin text-white ${size}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        );

        const AnalyticsCard = ({ title, icon, children }) => (
            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-md h-full">
                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    {icon && React.cloneElement(icon, { className: "h-6 w-6 mr-3 text-orange-500" })}
                    {title}
                </h3>
                {children}
            </div>
        );

        const SnippetCard = ({ title, icon, children, className }) => (
            <div className={`bg-white p-4 rounded-lg shadow-md h-full ${className}`}>
                <h3 className="text-sm font-semibold text-gray-600 mb-2 flex items-center">
                    {icon}
                    {title}
                </h3>
                {children}
            </div>
        );


        const SentimentChart = ({ data }) => {
            const total = Object.values(data).reduce((sum, count) => sum + (count || 0), 0);
            if (total === 0) return <p className="text-gray-500">No data available.</p>;

            const sentiments = [
                { name: Sentiment.Positive, color: 'bg-emerald-500'},
                { name: Sentiment.Neutral, color: 'bg-gray-500'},
                { name: Sentiment.Negative, color: 'bg-red-500'},
            ];

            return (
                <div className="space-y-3">
                    {sentiments.map(({ name, color }) => {
                        const count = data[name] || 0;
                        const percentage = total > 0 ? (count / total) * 100 : 0;
                        if (count === 0) return null;
                        return (
                            <div key={name}>
                                <div className="flex justify-between mb-1 text-sm font-medium text-gray-700">
                                    <span>{name}</span>
                                    <span>{count} ({percentage.toFixed(1)}%)</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                    <div className={`h-2.5 rounded-full ${color}`} style={{ width: `${percentage}%` }}></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const KeywordList = ({ keywords, colorClass }) => (
            <div className="flex flex-wrap gap-2">
                {keywords.length > 0 ? keywords.map(({ keyword, count }, i) => (
                    <span key={i} className={`px-2.5 py-1 text-sm font-medium rounded-full ${colorClass}`}>
                        {keyword} <span className="text-xs opacity-75">({count})</span>
                    </span>
                )) : <p className="text-sm text-gray-500">No keywords identified.</p>}
            </div>
        );

        const PlatformIcon = ({ platform, className = "h-5 w-5" }) => {
            switch (platform) {
                case Platform.Google: return <GoogleIcon className={className} />;
                case Platform.Facebook: return <FacebookIcon className={className} />;
                case Platform.Yelp: return <YelpIcon className={className} />;
                case Platform.Trustpilot: return <TrustpilotIcon className={className} />;
                default: return null;
            }
        };

        const getTopKeywords = (testimonials, sentiment, count = 5) => {
            const stopWords = new Set(['i','me','my','myself','we','our','ours','ourselves','you','your','yours','yourself','yourselves','he','him','his','himself','she','her','herself','it','its','itself','they','them','their','theirs','themselves','what','which','who','whom','this','that','these','those','am','is','are','was','were','be','been','being','have','has','had','having','do','does','did','doing','a','an','the','and','but','if','or','because','as','until','while','of','at','by','for','with','about','against','between','into','through','during','before','after','above','below','to','from','up','down','in','out','on','off','over','under','again','further','then','once','here','there','when','where','why','how','all','any','both','each','few','more','most','other','some','such','no','nor','not','only','own','same','so','than','too','very','s','t','can','will','just','don','should','now', 'le', 'la', 'de', 'et', 'est', 'un', 'une', 'pour', 'que', 'pas', 'el', 'y', 'lo', 'mi']);
            
            const text = testimonials
                .filter(t => t.sentiment === sentiment)
                .map(t => t.originalText)
                .join(' ');

            if (!text) return [];

            const words = text
                .toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 3 && !stopWords.has(word));

            const wordCounts = {};
            for (const word of words) {
                wordCounts[word] = (wordCounts[word] || 0) + 1;
            }

            return Object.entries(wordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, count)
                .map(([keyword, count]) => ({ keyword, count }));
        };

        const getLanguageDistribution = (testimonials) => {
            const counts = {};
            if (!testimonials || testimonials.length === 0) return counts;
            
            testimonials.forEach(t => {
                let lang = 'English'; // Default
                const text = t.originalText.toLowerCase();
                // Basic heuristics for language detection based on common words
                if (/\b(très|bon|service|excellent|suis|mon|pour)\b/.test(text) && /\b(et|de|la|le)\b/.test(text)) {
                    lang = 'French';
                } else if (/\b(muy|bueno|excelente|servicio|gracias|fue)\b/.test(text) && /\b(y|el|la|lo)\b/.test(text)) {
                    lang = 'Spanish';
                }
                counts[lang] = (counts[lang] || 0) + 1;
            });
            return counts;
        };

        const [isReportModalOpen, setIsReportModalOpen] = React.useState(false);
        const [selectedIds, setSelectedIds] = React.useState(new Set());

        const allVisibleIds = React.useMemo(() => new Set(listTestimonials.map(t => t.id)), [listTestimonials]);
        const areAllSelected = allVisibleIds.size > 0 && Array.from(allVisibleIds).every(id => selectedIds.has(id));

        const handleSelect = (id) => {
          setSelectedIds(prev => {
              const newSet = new Set(prev);
              if (newSet.has(id)) {
                  newSet.delete(id);
              } else {
                  newSet.add(id);
              }
              return newSet;
          });
        };

        const handleSelectAll = () => {
            if (areAllSelected) {
                setSelectedIds(new Set());
            } else {
                setSelectedIds(new Set(allVisibleIds));
            }
        };

        const basicStats = React.useMemo(() => {
          if (allFilteredTestimonials.length === 0) {
            return {
              averageRating: 0,
              platformCounts: {},
              sentimentCounts: {
                [Sentiment.Positive]: 0,
                [Sentiment.Neutral]: 0,
                [Sentiment.Negative]: 0,
                [Sentiment.Unknown]: 0,
              },
              totalCount: 0,
              topPositiveKeywords: [],
              topNegativeKeywords: [],
              languageDistribution: {},
            };
          }

          const totalRating = allFilteredTestimonials.reduce((sum, t) => sum + t.rating, 0);
          const averageRating = totalRating / allFilteredTestimonials.length;

          const platformCounts = allFilteredTestimonials.reduce((acc, t) => {
            acc[t.platform] = (acc[t.platform] || 0) + 1;
            return acc;
          }, {});

          const sentimentCounts = allFilteredTestimonials.reduce(
            (acc, t) => {
              if (t.sentiment !== Sentiment.Unknown) {
                acc[t.sentiment] = (acc[t.sentiment] || 0) + 1;
              }
              return acc;
            },
            {
              [Sentiment.Positive]: 0,
              [Sentiment.Neutral]: 0,
              [Sentiment.Negative]: 0,
              [Sentiment.Unknown]: 0,
            }
          );

          return {
            averageRating,
            platformCounts,
            sentimentCounts,
            totalCount: allFilteredTestimonials.length,
            topPositiveKeywords: getTopKeywords(allFilteredTestimonials, Sentiment.Positive),
            topNegativeKeywords: getTopKeywords(allFilteredTestimonials, Sentiment.Negative),
            languageDistribution: getLanguageDistribution(allFilteredTestimonials),
          };
        }, [allFilteredTestimonials]);
        
        React.useEffect(() => {
          setSelectedIds(new Set());
        }, [allFilteredTestimonials]);

        return (
          <div className="space-y-8">
            {isReportModalOpen && analyticsReport && (
              <ReportModal report={analyticsReport} onClose={() => setIsReportModalOpen(false)} />
            )}
            <section>
              <div className="flex items-center mb-4">
                <TrendingUpIcon className="h-7 w-7 text-emerald-500 mr-3" />
                <h2 className="text-2xl font-bold text-gray-800">Featured Testimonials</h2>
              </div>
              {featuredTestimonials.length > 0 ? (
                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                  {featuredTestimonials.map(t => (
                     <div key={t.id} className="bg-white p-4 rounded-lg shadow-lg border border-amber-400 transform hover:-translate-y-1 transition-transform duration-300">
                        <div className="flex items-center mb-2">
                            <PlatformIcon platform={t.platform} className={`h-5 w-5 mr-2 ${PLATFORM_CONFIG[t.platform].color}`} />
                            <span className="font-semibold text-sm text-gray-700">{t.author}</span>
                        </div>
                        <div className="flex items-center mb-2">
                          {[...Array(5)].map((_, i) => (
                            <StarIcon key={i} className={`h-4 w-4 ${i < t.rating ? 'text-amber-400' : 'text-gray-300'}`} />
                          ))}
                        </div>
                        <p className="text-sm text-gray-600 italic line-clamp-4">"{t.editedText || t.originalText}"</p>
                     </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 bg-white rounded-lg shadow">
                  <p className="text-gray-500">Approve some positive testimonials to see them featured here.</p>
                </div>
              )}
            </section>

            <section>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                   <div className="flex items-baseline flex-wrap gap-x-3">
                      <h2 className="text-2xl font-bold text-gray-800">Analytics & Testimonial Feed</h2>
                      <span className="text-sm text-gray-600">
                          Showing {listTestimonials.length} of {allFilteredTestimonials.length}
                      </span>
                  </div>
                  {analyticsReport && (
                      <button 
                          onClick={() => setIsReportModalOpen(true)}
                          className="mt-2 sm:mt-0 flex items-center px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-md hover:bg-emerald-700 disabled:bg-emerald-400 disabled:cursor-not-allowed transition-colors"
                      >
                          <DocumentTextIcon className="h-4 w-4 mr-2" />
                          View Detailed Report
                      </button>
                  )}
              </div>
              <div className="flex flex-col md:flex-row flex-wrap gap-4 mb-6 p-4 bg-white rounded-lg shadow items-center">
                <div className="flex-grow w-full md:w-auto">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                  <select value={platformFilter} onChange={(e) => setPlatformFilter(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="all">All Platforms</option>
                    {Object.values(Platform).map(p => <option key={p} value={p}>{p}</option>)}
                  </select>
                </div>
                <div className="flex-grow w-full md:w-auto">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sentiment</label>
                  <select value={sentimentFilter} onChange={(e) => setSentimentFilter(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="all">All Sentiments</option>
                    {Object.values(Sentiment).filter(s => s !== Sentiment.Unknown).map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div className="flex-grow w-full md:w-auto">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                  <select value={timeRange} onChange={(e) => setTimeRange(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="all">All Time</option>
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                  </select>
                </div>
                <div className="flex-grow w-full md:w-auto">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Rating</label>
                  <select value={ratingFilter} onChange={(e) => setRatingFilter(e.target.value === 'all' ? 'all' : parseInt(e.target.value))} className="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="all">All Ratings</option>
                    {[5,4,3,2,1].map(r => <option key={r} value={r}>{r} Star{r > 1 ? 's' : ''}</option>)}
                  </select>
                </div>
                <div className="flex-grow w-full md:w-auto">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Approval Status</label>
                  <select value={approvalFilter} onChange={(e) => setApprovalFilter(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="all">All Statuses</option>
                    <option value="approved">Approved</option>
                    <option value="unapproved">Unapproved</option>
                  </select>
                </div>
                <div className="flex-grow w-full md:w-auto">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                  <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                    <option value="rating-desc">Rating: High-Low</option>
                    <option value="rating-asc">Rating: Low-High</option>
                  </select>
                </div>
                <div className="w-full md:w-auto pt-2 md:pt-6">
                  <button onClick={() => onGenerateAnalytics(allFilteredTestimonials)} disabled={isAnalyzing || !isApiKeySet} className="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 disabled:bg-orange-300 disabled:cursor-not-allowed transition-colors">
                    {isAnalyzing ? <><LoadingSpinner size="h-4 w-4" /> <span className="ml-2">Analyzing...</span></> : <><BeakerIcon className="h-4 w-4 mr-2" /> Generate AI Report</>}
                  </button>
                </div>
              </div>

              {!isAnalyzing && !analyticsReport && (
                  <div className="mb-8">
                      <h3 className="text-lg font-bold text-gray-700 mb-4">Performance at a Glance</h3>
                      {allFilteredTestimonials.length > 0 ? (
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                              <SnippetCard title="Average Rating" icon={<StarIcon className="h-5 w-5 mr-2 text-amber-500"/>}>
                                  <p className="text-3xl font-bold text-gray-800">{basicStats.averageRating.toFixed(2)}</p>
                                  <p className="text-xs text-gray-500">from {basicStats.totalCount} filtered reviews</p>
                              </SnippetCard>
                               <SnippetCard title="Sentiment Breakdown" icon={<ChartPieIcon className="h-5 w-5 mr-2 text-orange-500"/>}>
                                 <SentimentChart data={basicStats.sentimentCounts} />
                              </SnippetCard>
                              <SnippetCard title="Platform Breakdown" icon={<LayoutDashboardIcon className="h-5 w-5 mr-2 text-indigo-500"/>}>
                                  <div className="space-y-2">
                                      {Object.entries(basicStats.platformCounts).sort(([, a], [, b]) => b - a).map(([platform, count]) => (
                                          <div key={platform} className="flex justify-between items-center text-sm">
                                              <div className="flex items-center">
                                                  <PlatformIcon platform={platform} className="h-4 w-4 mr-2" />
                                                  <span className="text-gray-700">{platform}</span>
                                              </div>
                                              <span className="font-semibold text-gray-800">{count}</span>
                                          </div>
                                      ))}
                                  </div>
                              </SnippetCard>
                              <SnippetCard title="Language Snippet" icon={<LanguageIcon className="h-5 w-5 mr-2 text-sky-500" />}>
                                 <div className="space-y-2">
                                      {Object.entries(basicStats.languageDistribution).sort(([, a], [, b]) => b - a).map(([lang, count]) => (
                                          <div key={lang} className="flex justify-between items-center text-sm">
                                              <span className="text-gray-700">{lang}</span>
                                              <span className="font-semibold text-gray-800">{count}</span>
                                          </div>
                                      ))}
                                  </div>
                              </SnippetCard>
                              <SnippetCard title="Positive Keyword Snippet" icon={<TagIcon className="h-5 w-5 mr-2 text-emerald-500" />}>
                                 <KeywordList keywords={basicStats.topPositiveKeywords} colorClass="bg-emerald-100 text-emerald-800" />
                              </SnippetCard>
                              <SnippetCard title="Negative Keyword Snippet" icon={<TagIcon className="h-5 w-5 mr-2 text-red-500" />}>
                                 <KeywordList keywords={basicStats.topNegativeKeywords} colorClass="bg-red-100 text-red-800" />
                              </SnippetCard>
                          </div>
                      ) : (
                          <div className="text-center py-6 bg-white rounded-lg shadow">
                            <p className="text-gray-500">No testimonials match the current filters to show stats.</p>
                          </div>
                      )}
                  </div>
              )}

              {(isAnalyzing || analyticsReport) && (
                  <div className="mb-8">
                      {isAnalyzing ? (
                          <div className="text-center py-10 bg-white rounded-lg shadow">
                            <div className="flex justify-center items-center">
                               <LoadingSpinner size="h-8 w-8" />
                               <p className="text-lg ml-4 text-gray-600">AI is analyzing testimonials...</p>
                            </div>
                          </div>
                      ) : analyticsReport && (
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                              <AnalyticsCard title="Sentiment Breakdown" icon={<ChartPieIcon/>}>
                                 <SentimentChart data={analyticsReport.sentimentBreakdown} />
                              </AnalyticsCard>
                              <AnalyticsCard title="Brand Perception" icon={<LightBulbIcon/>}>
                                 <p className="text-sm text-gray-600 italic">"{analyticsReport.brandPerceptionSummary}"</p>
                              </AnalyticsCard>
                               <AnalyticsCard title="Language Distribution" icon={<LanguageIcon />}>
                                  {analyticsReport.languageUsage && analyticsReport.languageUsage.length > 0 ? (
                                      <ul className="space-y-1 text-sm text-gray-600">
                                          {analyticsReport.languageUsage.map(({ language, count }) => (
                                              <li key={language}><strong>{language}:</strong> {count} review(s)</li>
                                          ))}
                                      </ul>
                                  ) : <p className="text-sm text-gray-500">Could not determine language usage.</p>}
                              </AnalyticsCard>
                              <AnalyticsCard title="Positive Keywords" icon={<TagIcon/>}>
                                 <KeywordList keywords={analyticsReport.positiveKeywords} colorClass="bg-emerald-100 text-emerald-800" />
                              </AnalyticsCard>
                              <AnalyticsCard title="Negative Keywords" icon={<TagIcon/>}>
                                 <KeywordList keywords={analyticsReport.negativeKeywords} colorClass="bg-red-100 text-red-800" />
                              </AnalyticsCard>
                              <div className="md:col-span-2 lg:col-span-1">
                                 <AnalyticsCard title="Points of Complaint" icon={<ChatBubbleBottomCenterTextIcon />}>
                                      {analyticsReport.complaints.length > 0 ? (
                                          <ul className="space-y-3">
                                              {analyticsReport.complaints.map((c, i) => (
                                                  <li key={i} className="text-sm border-l-4 border-red-500 pl-3">
                                                      <div className="flex items-center space-x-2 mb-1">
                                                          <PlatformIcon platform={c.platform} className={`h-4 w-4 ${PLATFORM_CONFIG[c.platform].color}`} />
                                                          <span className="font-semibold text-gray-700">{c.platform}</span>
                                                      </div>
                                                      <p className="text-gray-600 italic">"{c.complaint}"</p>
                                                  </li>
                                              ))}
                                          </ul>
                                      ) : <p className="text-sm text-gray-500">No specific complaints found in this selection.</p>}
                                  </AnalyticsCard>
                              </div>
                          </div>
                      )}
                  </div>
              )}
            </section>

            <section>
              {selectedIds.size > 0 && (
                <div className="sticky top-[65px] md:top-20 z-30 bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow-md mb-4 flex flex-col sm:flex-row items-center justify-between gap-3">
                  <div className="flex items-center gap-3">
                    <input
                        type="checkbox"
                        className="h-5 w-5 rounded border-gray-400 text-orange-600 focus:ring-orange-500 cursor-pointer"
                        checked={areAllSelected}
                        onChange={handleSelectAll}
                        aria-label="Select all testimonials"
                    />
                    <span className="font-semibold text-gray-700">{selectedIds.size} selected</span>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap justify-center">
                    <button onClick={() => { onBatchClean(selectedIds); setSelectedIds(new Set()); }} className="flex items-center px-3 py-1.5 text-xs font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600 transition-colors"><SparklesIcon className="h-4 w-4 mr-1.5"/>Clean</button>
                    <button onClick={() => { onBatchAnalyzeSentiment(selectedIds); setSelectedIds(new Set()); }} className="flex items-center px-3 py-1.5 text-xs font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600 transition-colors"><BeakerIcon className="h-4 w-4 mr-1.5"/>Analyze</button>
                    <button onClick={() => { onBatchApprove(Array.from(selectedIds), true); setSelectedIds(new Set()); }} className="flex items-center px-3 py-1.5 text-xs font-medium text-emerald-700 bg-emerald-100 rounded-md hover:bg-emerald-200 transition-colors"><CheckCircleIcon className="h-4 w-4 mr-1.5"/>Approve</button>
                    <button onClick={() => { onBatchApprove(Array.from(selectedIds), false); setSelectedIds(new Set()); }} className="flex items-center px-3 py-1.5 text-xs font-medium text-red-700 bg-red-100 rounded-md hover:bg-red-200 transition-colors"><XCircleIcon className="h-4 w-4 mr-1.5"/>Unapprove</button>
                  </div>
                </div>
              )}
              <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                {listTestimonials.length > 0 ? (
                  listTestimonials.map(testimonial => (
                    <TestimonialCard
                      key={testimonial.id}
                      testimonial={testimonial}
                      isSelected={selectedIds.has(testimonial.id)}
                      onSelect={handleSelect}
                      onClean={onClean}
                      onAnalyzeSentiment={onAnalyzeSentiment}
                      onUpdateText={onUpdateText}
                      onApprove={onApprove}
                      loadingStates={loadingStates}
                      isApiKeySet={isApiKeySet}
                    />
                  ))
                ) : (
                   <div className="lg:col-span-2 xl:col-span-3 text-center py-8 bg-white rounded-lg shadow">
                      <p className="text-gray-500">No testimonials match the current filters.</p>
                   </div>
                )}
              </div>
              {listTestimonials.length < allFilteredTestimonials.length && (
                  <div className="mt-8 text-center">
                      <button
                          onClick={onLoadMore}
                          className="px-6 py-3 text-sm font-semibold text-white bg-orange-500 rounded-lg shadow-md hover:bg-orange-600 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50"
                      >
                          Load More Testimonials
                      </button>
                  </div>
              )}
            </section>
          </div>
        );
      };

      // --- From components/Header.tsx ---
      const Header = ({ activeView, setActiveView, onApiKeyClick }) => {
        const navItemClasses = "flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200";
        const activeClasses = "bg-orange-500 text-white";
        const inactiveClasses = "text-gray-600 hover:bg-gray-200";

        return (
          <header className="bg-white shadow-md sticky top-0 z-40">
            <div className="container mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex items-center justify-between h-16">
                <div className="flex items-center space-x-3">
                  <div className="bg-orange-500 p-2 rounded-lg">
                    <TestTubeDiagonalIcon className="h-6 w-6 text-white" />
                  </div>
                  <h1 className="text-xl font-bold text-gray-800">
                    Client Testimonial Aggregator
                  </h1>
                </div>

                <div className="hidden md:flex items-center space-x-4">
                  <nav className="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg">
                    <button
                      onClick={() => setActiveView('dashboard')}
                      className={`${navItemClasses} ${activeView === 'dashboard' ? activeClasses : inactiveClasses}`}
                    >
                      <LayoutDashboardIcon className="h-5 w-5 mr-2" />
                      Dashboard
                    </button>
                    <button
                      onClick={() => setActiveView('competition')}
                      className={`${navItemClasses} ${activeView === 'competition' ? activeClasses : inactiveClasses}`}
                    >
                      <UsersIcon className="h-5 w-5 mr-2" />
                      Competition
                    </button>
                    <button
                      onClick={() => setActiveView('widget')}
                      className={`${navItemClasses} ${activeView === 'widget' ? activeClasses : inactiveClasses}`}
                    >
                      <PaletteIcon className="h-5 w-5 mr-2" />
                      Widget Customizer
                    </button>
                  </nav>
                  <button onClick={onApiKeyClick} className="p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:text-orange-500 transition-colors" aria-label="API Key Settings">
                      <KeyIcon className="h-6 w-6" />
                  </button>
                </div>
                
                <div className="md:hidden flex items-center">
                   <button onClick={onApiKeyClick} className="p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:text-orange-500 transition-colors" aria-label="API Key Settings">
                      <KeyIcon className="h-6 w-6" />
                  </button>
                </div>
              </div>
            </div>
             <nav className="md:hidden grid grid-cols-3 items-center justify-center gap-1 bg-gray-100 p-1 border-t border-gray-200">
                  <button
                    onClick={() => setActiveView('dashboard')}
                    className={`${navItemClasses} ${activeView === 'dashboard' ? activeClasses : inactiveClasses} justify-center text-xs`}
                  >
                    <LayoutDashboardIcon className="h-5 w-5 md:mr-2" />
                    <span className="hidden sm:inline-block ml-2">Dashboard</span>
                  </button>
                   <button
                    onClick={() => setActiveView('competition')}
                    className={`${navItemClasses} ${activeView === 'competition' ? activeClasses : inactiveClasses} justify-center text-xs`}
                  >
                    <UsersIcon className="h-5 w-5 md:mr-2" />
                    <span className="hidden sm:inline-block ml-2">Competition</span>
                  </button>
                  <button
                    onClick={() => setActiveView('widget')}
                    className={`${navItemClasses} ${activeView === 'widget' ? activeClasses : inactiveClasses} justify-center text-xs`}
                  >
                    <PaletteIcon className="h-5 w-5 md:mr-2" />
                     <span className="hidden sm:inline-block ml-2">Widget</span>
                  </button>
                </nav>
          </header>
        );
      };

      // --- From App.tsx ---
      const App = () => {
        const { useState, useMemo, useCallback, useEffect } = React;
        const [testimonials, setTestimonials] = useState(MOCK_TESTIMONIALS);
        const [competitors, setCompetitors] = useState(() => {
          try {
            const saved = localStorage.getItem('competitors');
            return saved ? JSON.parse(saved) : [];
          } catch (error) {
            console.error("Failed to parse competitors from localStorage", error);
            return [];
          }
        });

        const [activeView, setActiveView] = useState('dashboard');
        const [loadingStates, setLoadingStates] = useState({});
        const [widgetSettings, setWidgetSettings] = useState({
          theme: 'light',
          primaryColor: '#f97316',
          textColor: '#374151',
          backgroundColor: '#FFFFFF',
          font: 'Inter',
        });
        const [analyticsReport, setAnalyticsReport] = useState(null);
        const [isAnalyzing, setIsAnalyzing] = useState(false);
        
        const [competitionReport, setCompetitionReport] = useState(null);
        const [isAnalyzingCompetition, setIsAnalyzingCompetition] = useState(false);

        const [platformFilter, setPlatformFilter] = useState('all');
        const [sentimentFilter, setSentimentFilter] = useState('all');
        const [timeRange, setTimeRange] = useState('all');
        const [ratingFilter, setRatingFilter] = useState('all');
        const [approvalFilter, setApprovalFilter] = useState('all');
        const [sortBy, setSortBy] = useState('date-desc');
        const [visibleCount, setVisibleCount] = useState(15);

        const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
        const [showApiKeyModal, setShowApiKeyModal] = useState(false);

        useEffect(() => {
          if (apiKey) {
            localStorage.setItem('gemini_api_key', apiKey);
          } else {
            localStorage.removeItem('gemini_api_key');
          }
        }, [apiKey]);

        useEffect(() => {
          if (!apiKey) {
            setShowApiKeyModal(true);
          }
        }, []);

        const geminiService = useMemo(() => {
          if (apiKey) {
            try {
              return new GeminiService(apiKey);
            } catch(e) {
              console.error("Error initializing Gemini Service:", e);
              toast.error("Failed to initialize AI Service. Check API Key.");
              setApiKey(''); // Clear bad key
              return null;
            }
          }
          return null;
        }, [apiKey]);

        const isApiKeySet = !!geminiService;

        const requireApiKey = useCallback(() => {
          if (!geminiService) {
            toast.error("AI features are disabled. Please set your Gemini API key.");
            setShowApiKeyModal(true);
            return false;
          }
          return true;
        }, [geminiService]);

        useEffect(() => {
          localStorage.setItem('competitors', JSON.stringify(competitors));
        }, [competitors]);

        useEffect(() => {
          setVisibleCount(15);
        }, [platformFilter, sentimentFilter, timeRange, ratingFilter, approvalFilter, sortBy]);
        
        const filteredTestimonials = useMemo(() => {
          const filtered = testimonials.filter(t => {
              const platformMatch = platformFilter === 'all' || t.platform === platformFilter;
              const sentimentMatch = sentimentFilter === 'all' || t.sentiment === sentimentFilter;
              const ratingMatch = ratingFilter === 'all' || t.rating === ratingFilter;
              const approvalMatch = approvalFilter === 'all' || (approvalFilter === 'approved' && t.isApproved) || (approvalFilter === 'unapproved' && !t.isApproved);
              
              let dateMatch = true;
              if (timeRange !== 'all') {
                  const days = parseInt(timeRange);
                  const testimonialDate = new Date(t.date);
                  const cutoffDate = new Date();
                  cutoffDate.setDate(cutoffDate.getDate() - days);
                  dateMatch = testimonialDate >= cutoffDate;
              }
              
              return platformMatch && sentimentMatch && dateMatch && ratingMatch && approvalMatch;
          });

          return filtered.sort((a, b) => {
              switch (sortBy) {
                  case 'date-asc':
                      return new Date(a.date).getTime() - new Date(b.date).getTime();
                  case 'rating-desc':
                      return b.rating - a.rating;
                  case 'rating-asc':
                      return a.rating - b.rating;
                  case 'date-desc':
                  default:
                      return new Date(b.date).getTime() - new Date(a.date).getTime();
              }
          });
        }, [testimonials, platformFilter, sentimentFilter, timeRange, ratingFilter, approvalFilter, sortBy]);

        const paginatedTestimonials = useMemo(() => {
          return filteredTestimonials.slice(0, visibleCount);
        }, [filteredTestimonials, visibleCount]);

        const handleLoadMore = () => {
          setVisibleCount(prev => prev + 20);
        };

        const handleClean = useCallback(async (id, originalText) => {
          if (!requireApiKey()) return;
          setLoadingStates(prev => ({ ...prev, [id]: { ...prev[id], cleaning: true } }));
          try {
            const cleanedText = await geminiService.cleanTestimonialWithAI(originalText);
            setTestimonials(prev =>
              prev.map(t => (t.id === id ? { ...t, cleanedText: cleanedText, editedText: cleanedText } : t))
            );
            toast.success("Testimonial cleaned successfully!");
          } catch (error) {
            console.error("Error cleaning testimonial:", error);
            toast.error("Failed to clean testimonial with AI.");
          } finally {
            setLoadingStates(prev => ({ ...prev, [id]: { ...prev[id], cleaning: false } }));
          }
        }, [geminiService, requireApiKey]);

        const handleAnalyzeSentiment = useCallback(async (id, text) => {
          if (!requireApiKey()) return;
          setLoadingStates(prev => ({ ...prev, [id]: { ...prev[id], sentiment: true } }));
          try {
            const sentiment = await geminiService.analyzeSentimentWithAI(text);
            setTestimonials(prev =>
              prev.map(t => (t.id === id ? { ...t, sentiment } : t))
            );
            toast.success("Sentiment analyzed successfully!");
          } catch (error) {
            console.error("Error analyzing sentiment:", error);
            toast.error("Failed to analyze sentiment.");
          } finally {
            setLoadingStates(prev => ({ ...prev, [id]: { ...prev[id], sentiment: false } }));
          }
        }, [geminiService, requireApiKey]);

        const handleGenerateAnalytics = useCallback(async (testimonialsToAnalyze) => {
          if (!requireApiKey()) return;
          if(testimonialsToAnalyze.length === 0){
              toast.info("No testimonials match the current filters to analyze.");
              return;
          }
          setIsAnalyzing(true);
          setAnalyticsReport(null);
          try {
            const report = await geminiService.generateAnalyticsReport(testimonialsToAnalyze);
            setAnalyticsReport(report);
            toast.success("Analytics report generated!");
          } catch(error) {
            console.error("Error generating analytics:", error);
            toast.error("Failed to generate analytics report.");
          } finally {
            setIsAnalyzing(false);
          }
        }, [geminiService, requireApiKey]);

         const handleAnalyzeCompetition = useCallback(async (competitor) => {
          if (!requireApiKey()) return;
          if (filteredTestimonials.length === 0) {
            toast.info("You need at least one testimonial matching the current filters to run a comparison.");
            return;
          }
          setIsAnalyzingCompetition(true);
          setCompetitionReport(null);
          try {
              const report = await geminiService.generateCompetitionReport(filteredTestimonials, competitor);
              setCompetitionReport(report);
              toast.success("Competition analysis complete!");
          } catch(error) {
              console.error("Error analyzing competition:", error);
              toast.error("Failed to generate competition analysis.");
          } finally {
              setIsAnalyzingCompetition(false);
          }
        }, [geminiService, requireApiKey, filteredTestimonials]);

        const handleAddOrUpdateCompetitor = (competitor) => {
          setCompetitors(prev => {
              const existing = prev.find(c => c.id === competitor.id);
              if (existing) {
                  return prev.map(c => c.id === competitor.id ? competitor : c);
              } else {
                  return [...prev, competitor];
              }
          });
        };

        const handleDeleteCompetitor = (competitorId) => {
          setCompetitors(prev => prev.filter(c => c.id !== competitorId));
          toast.info("Competitor removed from watchlist.");
        };

        const handleUpdateText = (id, newText) => {
          setTestimonials(prev =>
            prev.map(t => (t.id === id ? { ...t, editedText: newText } : t))
          );
        };

        const handleApprove = (id, isApproved) => {
          setTestimonials(prev =>
            prev.map(t => (t.id === id ? { ...t, isApproved } : t))
          );
        };

        const handleBatchApprove = useCallback((ids, isApproved) => {
          setTestimonials(prev =>
            prev.map(t => (ids.includes(t.id) ? { ...t, isApproved } : t))
          );
          toast.success(`${ids.length} testimonials have been ${isApproved ? 'approved' : 'unapproved'}.`);
        }, []);
        
        const handleBatchClean = useCallback(async (ids) => {
          if (!requireApiKey()) return;
          setLoadingStates(prev => {
              const newStates = {...prev};
              ids.forEach(id => { newStates[id] = { ...newStates[id], cleaning: true }; });
              return newStates;
          });
          try {
              const testimonialsToClean = testimonials.filter(t => ids.has(t.id));
              const cleanPromises = testimonialsToClean.map(t => 
                  geminiService.cleanTestimonialWithAI(t.originalText).then(cleanedText => ({ id: t.id, cleanedText }))
              );
              const results = await Promise.all(cleanPromises);
              setTestimonials(prev => {
                  const newTestimonials = [...prev];
                  results.forEach(result => {
                      const index = newTestimonials.findIndex(t => t.id === result.id);
                      if (index > -1) {
                          newTestimonials[index] = { ...newTestimonials[index], cleanedText: result.cleanedText, editedText: result.cleanedText };
                      }
                  });
                  return newTestimonials;
              });
              toast.success(`${ids.size} testimonials cleaned successfully!`);
          } catch (error) {
              console.error("Error batch cleaning testimonials:", error);
              toast.error("Failed to clean some testimonials with AI.");
          } finally {
              setLoadingStates(prev => {
                  const newStates = {...prev};
                  ids.forEach(id => { newStates[id] = { ...newStates[id], cleaning: false }; });
                  return newStates;
              });
          }
        }, [geminiService, requireApiKey, testimonials]);

        const handleBatchAnalyzeSentiment = useCallback(async (ids) => {
          if (!requireApiKey()) return;
           setLoadingStates(prev => {
              const newStates = {...prev};
              ids.forEach(id => { newStates[id] = { ...newStates[id], sentiment: true }; });
              return newStates;
          });
          try {
              const testimonialsToAnalyze = testimonials.filter(t => ids.has(t.id));
              const analyzePromises = testimonialsToAnalyze.map(t => 
                  geminiService.analyzeSentimentWithAI(t.originalText).then(sentiment => ({ id: t.id, sentiment }))
              );
              const results = await Promise.all(analyzePromises);
               setTestimonials(prev => {
                  const newTestimonials = [...prev];
                  results.forEach(result => {
                      const index = newTestimonials.findIndex(t => t.id === result.id);
                      if (index > -1) {
                          newTestimonials[index] = { ...newTestimonials[index], sentiment: result.sentiment };
                      }
                  });
                  return newTestimonials;
              });
            toast.success(`Sentiment analyzed for ${ids.size} testimonials!`);
          } catch (error) {
            console.error("Error batch analyzing sentiment:", error);
            toast.error("Failed to analyze sentiment for some testimonials.");
          } finally {
            setLoadingStates(prev => {
                  const newStates = {...prev};
                  ids.forEach(id => { newStates[id] = { ...newStates[id], sentiment: false }; });
                  return newStates;
              });
          }
        }, [geminiService, requireApiKey, testimonials]);

        const featuredTestimonials = useMemo(() => {
          return [...testimonials]
            .filter(t => t.isApproved)
            .sort((a, b) => {
              if (a.rating !== b.rating) return b.rating - a.rating;
              const sentimentOrder = { Positive: 1, Neutral: 2, Negative: 3 };
              return sentimentOrder[a.sentiment] - sentimentOrder[b.sentiment];
            })
            .slice(0, 5);
        }, [testimonials]);

        const approvedTestimonials = useMemo(() => testimonials.filter(t => t.isApproved), [testimonials]);
        
        const renderContent = () => {
          switch (activeView) {
              case 'dashboard':
                  return <Dashboard
                      listTestimonials={paginatedTestimonials}
                      allFilteredTestimonials={filteredTestimonials}
                      featuredTestimonials={featuredTestimonials}
                      onClean={handleClean}
                      onAnalyzeSentiment={handleAnalyzeSentiment}
                      onUpdateText={handleUpdateText}
                      onApprove={handleApprove}
                      loadingStates={loadingStates}
                      isApiKeySet={isApiKeySet}
                      analyticsReport={analyticsReport}
                      isAnalyzing={isAnalyzing}
                      onGenerateAnalytics={handleGenerateAnalytics}
                      onLoadMore={handleLoadMore}
                      platformFilter={platformFilter}
                      setPlatformFilter={setPlatformFilter}
                      sentimentFilter={sentimentFilter}
                      setSentimentFilter={setSentimentFilter}
                      timeRange={timeRange}
                      setTimeRange={setTimeRange}
                      ratingFilter={ratingFilter}
                      setRatingFilter={setRatingFilter}
                      approvalFilter={approvalFilter}
                      setApprovalFilter={setApprovalFilter}
                      sortBy={sortBy}
                      setSortBy={setSortBy}
                      onBatchApprove={handleBatchApprove}
                      onBatchClean={handleBatchClean}
                      onBatchAnalyzeSentiment={handleBatchAnalyzeSentiment}
                  />;
              case 'widget':
                  return <WidgetCustomizer
                      settings={widgetSettings}
                      setSettings={setWidgetSettings}
                      testimonials={approvedTestimonials}
                  />;
              case 'competition':
                  return <CompetitionAnalysis
                      competitors={competitors}
                      onAnalyze={handleAnalyzeCompetition}
                      onDelete={handleDeleteCompetitor}
                      onSave={handleAddOrUpdateCompetitor}
                      report={competitionReport}
                      isAnalyzing={isAnalyzingCompetition}
                      isApiKeySet={isApiKeySet}
                  />;
              default:
                  return null;
          }
        }

        return (
          <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
            <Toaster />
            {showApiKeyModal && <ApiKeyModal value={apiKey} onChange={setApiKey} onClose={() => setShowApiKeyModal(false)} />}
            <Header activeView={activeView} setActiveView={setActiveView} onApiKeyClick={() => setShowApiKeyModal(true)} />
            <main className="p-4 sm:p-6 lg:p-8">
              {renderContent()}
            </main>
          </div>
        );
      };

      // --- From index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
